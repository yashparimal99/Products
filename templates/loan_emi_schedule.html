<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EMI Schedule — {{ loan_account.loan_account_no }}</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"/>

    <style>
        :root {
            --brand: #0B4D83;
            --brand-alt: #97144D;
            --bg-page: #f1f5f9;
            --border-soft: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
        }

        body {
            background: radial-gradient(circle at top left, #e3f2fd 0, #f1f5f9 40%, #ffffff 100%);
            font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-main);
        }

        .page-shell {
            max-width: 1150px;
            margin: 24px auto 40px;
        }

        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .top-row-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .top-header {
            background: linear-gradient(90deg, #0B4D83, #186cc4);
            border-radius: 16px;
            padding: 18px 22px;
            color: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.18);
            margin-bottom: 18px;
        }

        .top-header-main {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .top-title {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .top-title i {
            font-size: 22px;
        }

        .top-subtitle {
            font-size: 13px;
            font-weight: 500;
            opacity: 0.95;
        }

        .card-block {
            background-color: #ffffff;
            border-radius: 14px;
            border: 1px solid var(--border-soft);
            padding: 16px 20px 20px;
            box-shadow: 0 2px 10px rgba(15, 23, 42, 0.06);
            margin-bottom: 18px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 12px;
        }

        .summary-card {
            border-radius: 12px;
            padding: 12px 14px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
        }

        .summary-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: .05em;
        }

        .summary-value {
            font-size: 15px;
            font-weight: 700;
            margin-top: 4px;
        }

        .summary-sub {
            font-size: 11px;
            color: var(--text-muted);
        }

        table.dataTable thead th {
            background-color: #0B4D83;
            color: #ffffff !important;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        table.dataTable tbody td {
            vertical-align: middle;
            font-size: 13px;
        }

        .amount-cell {
            text-align: right;
            font-weight: 500;
        }

        .status-badge {
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-pending {
            background-color: #fef9c3;
            color: #92400e;
        }

        .status-paid {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-overdue {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .text-small-muted {
            font-size: 11px;
            color: var(--text-muted);
        }

        @media (max-width: 992px) {
            .summary-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 576px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div class="page-shell">

    <!-- Top row -->
    <div class="top-row">
        <div class="top-row-title">
            DigiBank • EMI Schedule
        </div>
        <div>
            <a href="{{ url_for('view_loans') }}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-arrow-left"></i> Back to My Loans
            </a>
            <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </div>
    </div>

    <!-- Header -->
    <div class="top-header">
        <div class="top-header-main">
            <h1 class="top-title">
                <i class="bi bi-calendar-week"></i>
                Loan A/c: {{ loan_account.loan_account_no }}
            </h1>
            <div class="top-subtitle">
                {{ loan_account.loan_type|title }} Loan • Applied on {{ loan_account.application_date }} • Application No: {{ loan_account.application_number }}
            </div>
        </div>
        <div class="text-end">
            <div class="fw-semibold">
                Outstanding:
                ₹{{ "{:,.0f}".format(loan_account.outstanding_principal|float) }}
            </div>
           
        </div>
    </div>

    <!-- Summary cards -->
    <div class="card-block">
        <div class="summary-grid mb-2">
            <div class="summary-card">
                <div class="summary-label">Total Principal</div>
                <div class="summary-value">
                    ₹{{ "{:,.0f}".format(total_principal|float) }}
                </div>
                <div class="summary-sub">Sum of principal components</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Total Interest</div>
                <div class="summary-value">
                    ₹{{ "{:,.0f}".format(total_interest|float) }}
                </div>
                <div class="summary-sub">Total interest over tenure</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Total EMI Outflow</div>
                <div class="summary-value">
                    ₹{{ "{:,.0f}".format(total_emi|float) }}
                </div>
                <div class="summary-sub">Principal + Interest</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Installments Status</div>
                <div class="summary-value">
                    {{ paid_installments }} paid / {{ pending_installments }} pending
                </div>
                <div class="summary-sub">
                    {% if overdue_installments > 0 %}
                        <span class="text-danger">{{ overdue_installments }} overdue</span>
                    {% else %}
                        No overdue installments
                    {% endif %}
                </div>
            </div>

            <!-- New card: Next EMI + Pay Now -->
            <div class="summary-card">
                <div class="summary-label">Next EMI Due</div>
                {% if next_due %}
                    <div class="summary-value">
                        ₹{{ "{:,.0f}".format(next_due.emi_amount|float) }}
                    </div>
                    <div class="summary-sub mb-2">
                        Instalment #{{ next_due.instalment_no }} • Due on {{ next_due.due_date }}<br>
                        Status: 
                        {% if next_due.status == 'overdue' %}
                            <span class="text-danger">Overdue</span>
                        {% else %}
                            {{ next_due.status|capitalize }}
                        {% endif %}
                    </div>
                    <a href="{{ url_for('confirm_pay_emi',
                    loan_account_id=loan_account.id,
                    instalment_no=next_due.instalment_no) }}"
                    class="btn btn-sm btn-primary w-100">
                    <i class="bi bi-wallet2"></i> Pay This EMI
                    </a>

                {% else %}
                    <div class="summary-value text-success">
                        All EMIs Paid
                    </div>
                    <div class="summary-sub">
                        Loan is fully repaid.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- EMI Schedule table -->
    <div class="card-block">
        <div class="mb-2">
            <div class="fw-semibold mb-1">EMI Schedule</div>
            <div class="text-small-muted">
                View month-wise breakup of your EMI into principal and interest. You can pay only the next due EMI.
            </div>
        </div>

        {% if schedule|length == 0 %}
            <div class="alert alert-info mb-0">
                EMI schedule is not available for this loan yet. Please contact the bank.
            </div>
        {% else %}
            <div class="table-responsive">
                <table id="scheduleTable" class="table table-striped table-bordered align-middle w-100">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Due Date</th>
                            <th>EMI (₹)</th>
                            <th>Principal (₹)</th>
                            <th>Interest (₹)</th>
                            <th>Opening Principal (₹)</th>
                            <th>Closing Principal (₹)</th>
                            <th>Status</th>
                            <th>Paid On</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for row in schedule %}
                        <tr class="{% if next_due and row.instalment_no == next_due.instalment_no and row.status in ['pending','overdue'] %}table-warning{% endif %}">
                            <td>{{ row.instalment_no }}</td>
                            <td>{{ row.due_date }}</td>
                            <td class="amount-cell">₹{{ "{:,.0f}".format(row.emi_amount|float) }}</td>
                            <td class="amount-cell">₹{{ "{:,.0f}".format(row.principal_component|float) }}</td>
                            <td class="amount-cell">₹{{ "{:,.0f}".format(row.interest_component|float) }}</td>
                            <td class="amount-cell">₹{{ "{:,.0f}".format(row.opening_principal|float) }}</td>
                            <td class="amount-cell">₹{{ "{:,.0f}".format(row.closing_principal|float) }}</td>
                            <td>
                                {% if row.status == 'paid' %}
                                    <span class="status-badge status-paid">Paid</span>
                                {% elif row.status == 'overdue' %}
                                    <span class="status-badge status-overdue">Overdue</span>
                                {% else %}
                                    <span class="status-badge status-pending">Pending</span>
                                {% endif %}
                            </td>
                            <td>
                                {{ row.paid_on or '-' }}
                            </td>
                            <td>
                                {% if next_due and row.instalment_no == next_due.instalment_no and row.status in ['pending','overdue'] %}
                                    <a href="{{ url_for('confirm_pay_emi',
                    loan_account_id=loan_account.id,
                    instalment_no=row.instalment_no) }}"
                    class="btn btn-sm btn-outline-primary">
                   Pay Now
                   </a>

                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
    </div>

</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
    $(document).ready(function () {
        $('#scheduleTable').DataTable({
            pageLength: 12,
            order: [[0, 'asc']]
        });
    });
</script>

</body>
</html>
