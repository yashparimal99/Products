<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>View Deposits - DigiBank Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
  <style>
    body { background:#f8f9fa; font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif; }
    #sidebarMenu.offcanvas-start { width:250px; }
    #sidebarMenu .nav-link.active { font-weight:700; color:#97144D!important; background:#f0d7e0; border-radius:4px; }
    .top-bar { background:#97144D; color:white; display:flex; align-items:center; justify-content:space-between; padding:10px 20px; position:sticky; top:0; z-index:1030; }
    .logout-btn { background:transparent; border:1.5px solid white; color:white; padding:5px 15px; border-radius:4px; font-weight:600; }
    .logout-btn:hover { background:white; color:#97144D; }
    .main-content { margin-left:250px; padding:20px; }
    .card { border:none; border-radius:10px; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
    .card-header { background:#97144D; color:white; border-radius:10px 10px 0 0!important; }
    .btn-primary { background:#97144D; border-color:#97144D; }
    .table th { background:#f1f1f1; }
  </style>
</head>
<body>
 
<!-- Sidebar -->
<div class="offcanvas offcanvas-start" id="sidebarMenu">
  <div class="offcanvas-header">
    <h5>Manager</h5>
    <button class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <ul class="nav flex-column">
      <li class="nav-item mb-2"><a class="nav-link" href="{{ url_for('managerapprovals') }}"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a></li>
      <li class="nav-item mb-2"><a class="nav-link" href="{{ url_for('manage_accounts') }}"><i class="bi bi-people-fill me-2"></i> Manage Accounts</a></li>
      <li class="nav-item mb-2"><a class="nav-link active" href="{{ url_for('manview_deposits') }}"><i class="bi bi-cash-stack me-2"></i> View Deposits</a></li>
    </ul>
  </div>
</div>
 
<!-- Top bar -->
<div class="top-bar">
  <button class="btn btn-outline-light btn-sm me-3" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu"><i class="bi bi-list"></i></button>
  <h5>DigiBank Manager Dashboard</h5>
  <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
</div>
 
<!-- Main content -->
<div class="main-content">
  <h2><i class="bi bi-cash-stack"></i> View Deposits</h2>
  <div class="card mt-3">
    <div class="card-header"><h5>Deposit Records</h5></div>
    <div class="card-body">
 
      <!-- Filters -->
      <div class="row mb-3">
        <div class="col-md-3">
          <label class="form-label">From Date</label>
          <input type="date" class="form-control" id="fromDate">
        </div>
        <div class="col-md-3">
          <label class="form-label">To Date</label>
          <input type="date" class="form-control" id="toDate">
        </div>
        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select class="form-select" id="statusFilter">
            <option value="all">All</option>
            <option value="Pending">Pending</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
          </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button class="btn btn-primary me-2" onclick="applyFilters()">Apply</button>
          <button class="btn btn-outline-secondary" onclick="resetFilters()">Reset</button>
        </div>
      </div>
 
      <!-- Table -->
      <div class="table-responsive">
        <table class="table table-hover">
          <thead><tr>
            <th>Request ID</th><th>Customer Name</th><th>Deposit Type</th>
            <th>Amount</th><th>Date</th><th>Status</th><th>Actions</th>
          </tr></thead>
          <tbody id="depositTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
 
<!-- Modal -->
<div class="modal fade" id="depositDetailsModal">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header">
      <h5 id="depositModalTitle"></h5>
      <button class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body" id="depositModalBody"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      <button class="btn btn-primary" id="printDepositBtn"><i class="bi bi-printer"></i> Print</button>
    </div>
  </div></div>
</div>
 
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const deposits = {{ deposits|tojson }};
  const depositTableBody = document.getElementById('depositTableBody');
  const depositDetailsModal = new bootstrap.Modal(document.getElementById('depositDetailsModal'));
 
  function mapStatus(flag){ if(flag===null)return"Pending"; if(flag==="A")return"Approved"; if(flag==="R")return"Rejected"; return"Unknown"; }
  function getStatusBadgeClass(s){ if(s==="Approved")return"bg-success"; if(s==="Rejected")return"bg-danger"; if(s==="Pending")return"bg-warning text-dark"; return"bg-secondary"; }
 
  document.addEventListener('DOMContentLoaded', ()=>renderDepositsTable());
 
  function renderDepositsTable(data=deposits){
    depositTableBody.innerHTML='';
    if(!data.length){depositTableBody.innerHTML=`<tr><td colspan="7" class="text-center py-4">No deposits</td></tr>`;return;}
    data.forEach((d,i)=>{
      let amt=d.principal_amount||d.monthly_installment||'-';
      let status=mapStatus(d.status_flag);
      depositTableBody.innerHTML+=`
        <tr>
          <td>${d.request_id}</td>
          <td>${d.first_name} ${d.middle_name||''} ${d.last_name}</td>
          <td>${d.deposit_type}</td>
          <td>${amt}</td>
          <td>${d.created_at?d.created_at.split('T')[0]:''}</td>
          <td><span class="badge ${getStatusBadgeClass(status)}">${status}</span></td>
          <td>
            <button class="btn btn-sm btn-primary me-1" onclick="viewDepositDetails(${i})"><i class="bi bi-eye"></i></button>
            ${d.status_flag===null?`
              <button class="btn btn-sm btn-success me-1" onclick="approveDeposit(${i})"><i class="bi bi-check-circle"></i></button>
              <button class="btn btn-sm btn-danger" onclick="rejectDeposit(${i})"><i class="bi bi-x-circle"></i></button>
            `:''}
          </td>
        </tr>`;
    });
  }
 
  function viewDepositDetails(i){
    const d=deposits[i];
    document.getElementById('depositModalTitle').innerText=`Deposit ${d.request_id}`;
    document.getElementById('depositModalBody').innerHTML=`
      <p><b>Name:</b> ${d.first_name} ${d.last_name}</p>
      <p><b>Type:</b> ${d.deposit_type}</p>
      <p><b>Account:</b> ${d.account_number}</p>
      <p><b>Amount:</b> ${d.principal_amount||d.monthly_installment||'-'}</p>
      <p><b>Status:</b> ${mapStatus(d.status_flag)}</p>`;
    depositDetailsModal.show();
  }
 
  function approveDeposit(i){
    if(confirm(`Approve ${deposits[i].request_id}?`)){
      fetch(`/update_deposit_request/${deposits[i].request_id}/approve`,{method:'POST'}).then(r=>{
        if(r.ok){deposits[i].status_flag='A';renderDepositsTable();}
        else alert('Error approving');
      });
    }
  }
  function rejectDeposit(i){
    if(confirm(`Reject ${deposits[i].request_id}?`)){
      fetch(`/update_deposit_request/${deposits[i].request_id}/reject`,{method:'POST'}).then(r=>{
        if(r.ok){deposits[i].status_flag='R';renderDepositsTable();}
        else alert('Error rejecting');
      });
    }
  }
 
  function applyFilters(){
    const fromDate=document.getElementById('fromDate').value;
    const toDate=document.getElementById('toDate').value;
    const status=document.getElementById('statusFilter').value;
    let filtered=deposits.slice();
    if(fromDate){filtered=filtered.filter(d=>d.created_at && d.created_at.split('T')[0]>=fromDate);}
    if(toDate){filtered=filtered.filter(d=>d.created_at && d.created_at.split('T')[0]<=toDate);}
    if(status!=='all'){filtered=filtered.filter(d=>mapStatus(d.status_flag)===status);}
    renderDepositsTable(filtered);
  }
  function resetFilters(){
    document.getElementById('fromDate').value='';
    document.getElementById('toDate').value='';
    document.getElementById('statusFilter').value='all';
    renderDepositsTable(deposits);
  }
 
  document.getElementById('printDepositBtn').addEventListener('click',()=>{window.print();depositDetailsModal.hide();});
</script>
</body>
<footer ...>
 
 
  <!-- Footer -->
  <footer class="bg-custom text-white text-center py-3 mt-auto" style="background-color: #97144D;">
    Â© 2025 DigiBank. All rights reserved.
  </footer>
 
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
 
  <!-- <script>
    function logout() {
      alert("Logout clicked! Implement logout logic here.");
      // e.g. window.location.href = "login.html";
    }
  </script> -->
</body>
</html>
 
 