<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Loan Application Review</title>
 
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 
    <!-- BOOTSTRAP + ICONS -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        rel="stylesheet"
    >
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
 
    <style>
        :root {
            --brand: #0b4d83;
            --brand-2: #7a103c;
            --bg-soft: #f3f4f6;
            --ink: #111827;
            --muted: #6b7280;
        }
 
        body {
            background: var(--bg-soft);
            font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--ink);
            margin: 0;
            min-height: 100vh;
        }
 
        .top-bar {
            background: linear-gradient(90deg, var(--brand) 0%, var(--brand-2) 100%);
            padding: 12px 0;
            color: #ffffff;
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.2);
        }
 
        .top-bar .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.1rem;
        }
 
        .brand-badge {
            width: 30px;
            height: 30px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.9rem;
        }
 
        .top-meta {
            font-size: 0.8rem;
            opacity: 0.95;
        }
 
        .page-shell {
            padding: 18px 0 32px;
        }
 
        .page-title {
            font-size: 1.45rem;
            font-weight: 600;
            color: #111827;
        }
 
        .page-subtitle {
            font-size: 0.9rem;
            color: var(--muted);
        }
 
        .pill-ref {
            border-radius: 999px;
            padding: 3px 10px;
            background: #e5e7eb;
            font-size: 0.8rem;
            color: #374151;
        }
 
        .card-modern {
            border-radius: 16px;
            border: 1px solid #e5e7eb;
            background-color: #ffffff;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
        }
 
        .card-modern .card-header {
            border-radius: 16px 16px 0 0;
            border-bottom: 1px solid #e5e7eb;
            background-color: #f9fafb;
            font-weight: 600;
            font-size: 0.98rem;
        }
 
        .info-label {
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--muted);
        }
 
        .info-value {
            font-size: 0.98rem;
            font-weight: 500;
        }
 
        .badge-status {
            border-radius: 999px;
            padding: 4px 12px;
            font-size: 0.8rem;
            text-transform: capitalize;
        }
 
        .badge-status-submitted {
            background: rgba(59, 130, 246, 0.12);
            color: #1d4ed8;
        }
 
        .badge-status-agent_approved {
            background: rgba(16, 185, 129, 0.16);
            color: #047857;
        }
 
        .badge-status-under_review {
            background: rgba(245, 158, 11, 0.16);
            color: #b45309;
        }
 
        .badge-status-rejected {
            background: rgba(239, 68, 68, 0.14);
            color: #b91c1c;
        }
 
        .doc-box {
            padding: 14px 14px 10px;
            border-radius: 14px;
            border: 1px solid #e5e7eb;
            background-color: #ffffff;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
 
        .doc-title {
            font-size: 0.95rem;
            font-weight: 600;
        }
 
        .badge-doc {
            font-size: 0.75rem;
            border-radius: 999px;
            padding: 3px 9px;
        }
 
        .badge-doc-verified {
            background: rgba(22, 163, 74, 0.12);
            color: #15803d;
            border: 1px solid rgba(22, 163, 74, 0.4);
        }
 
        .badge-doc-unverified {
            background: rgba(156, 163, 175, 0.16);
            color: #4b5563;
            border: 1px solid rgba(156, 163, 175, 0.5);
        }
 
        .btn-pill {
            border-radius: 999px;
            font-size: 0.8rem;
            padding-inline: 14px;
        }
 
        .btn-outline-soft {
            border-color: #d1d5db;
            color: #374151;
        }
 
        .btn-outline-soft:hover {
            background-color: #e5e7eb;
            color: #111827;
        }
 
        .actions-bar {
            padding-top: 16px;
            border-top: 1px dashed #e5e7eb;
            margin-top: 16px;
        }
 
        .btn-approve {
            background: linear-gradient(90deg, #16a34a, #22c55e);
            border: none;
            color: #f0fdf4;
        }
 
        .btn-approve:hover {
            filter: brightness(1.05);
        }
 
        .btn-reject {
            background: linear-gradient(90deg, #b91c1c, #dc2626);
            border: none;
            color: #fef2f2;
        }
 
        .back-link {
            font-size: 0.85rem;
            color: var(--muted);
        }
 
        .back-link:hover {
            color: #111827;
        }
 
        .amount-text {
            font-variant-numeric: tabular-nums;
        }
 
        .form-switch .form-check-input {
            cursor: pointer;
        }
    </style>
</head>
<body>
 
<!-- TOP BAR -->
<div class="top-bar">
    <div class="container d-flex justify-content-between align-items-center">
        <div class="brand">
            <div class="brand-badge">DB</div>
            <div>DigiBank Underwriting</div>
        </div>
        <div class="top-meta text-end d-none d-md-block">
            <div class="fw-semibold">Loan Application Review</div>
            <div>Verify documents & send decision to Manager</div>
        </div>
    </div>
</div>
 
<div class="page-shell">
    <div class="container">
 
        <!-- HEADER / CONTEXT -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <div>
                <div class="page-title">Application Review</div>
                <div class="page-subtitle">
                    Check customer details and mark each document as <strong>Verified</strong> or <strong>Unverified</strong>.
                </div>
            </div>
            <div class="d-flex flex-column align-items-end gap-1">
                <div class="pill-ref">
                    <span style="font-size: 0.76rem; opacity: 0.7;">Application No.</span>
                    <span class="fw-semibold ms-2">
                        {{ app.application_number if app.application_number else "N/A" }}
                    </span>
                </div>
                <a href="{{ url_for('agent_dashboard') }}" class="back-link text-decoration-none">
                    <i class="bi bi-arrow-left-circle me-1"></i> Back to queue
                </a>
            </div>
        </div>
 
        <div class="row g-4">
            <!-- LEFT: Applicant & Loan Info -->
            <div class="col-lg-6">
                <div class="card card-modern h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-person-vcard me-2"></i> Applicant & Loan Details</span>
                        <span class="badge-status badge-status-{{ app.application_status }}">
                            <i class="bi bi-circle-fill me-1" style="font-size: 0.55rem;"></i>
                            {{ app.application_status.replace("_", " ") }}
                        </span>
                    </div>
                    <div class="card-body">
 
                        <div class="row gy-3">
                            <div class="col-md-6">
                                <div class="info-label">Applicant Name</div>
                                <div class="info-value">{{ app.full_name }}</div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-label">Email</div>
                                <div class="info-value">{{ app.email }}</div>
                            </div>
 
                            <div class="col-md-6">
                                <div class="info-label">Mobile</div>
                                <div class="info-value">{{ app.mobile }}</div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-label">PAN</div>
                                <div class="info-value">{{ app.pan_number }}</div>
                            </div>
 
                            <div class="col-md-6">
                                <div class="info-label">Loan Type</div>
                                <div class="info-value text-capitalize">{{ app.loan_type }}</div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-label">Loan Amount</div>
                                <div class="info-value amount-text">
                                    ₹{{ "{:,.2f}".format(app.loan_amount) }}
                                </div>
                            </div>
 
                            <div class="col-md-6">
                                <div class="info-label">CIBIL Score</div>
                                <div class="info-value">{{ app.cibil_score }}</div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-label">Purpose</div>
                                <div class="info-value">
                                    {{ app.loan_purpose if app.loan_purpose else "—" }}
                                </div>
                            </div>
                        </div>
 
                        <!-- Actions -->
                        <div class="actions-bar mt-4">
                            <div class="d-flex flex-wrap gap-2">
                                <!-- Approve & Send to Manager -->
                                <form
                                    action="{{ url_for('agent_approve_application', app_id=app.id) }}"
                                    method="POST"
                                    class="d-inline"
                                >
                                    <button class="btn btn-approve btn-pill">
                                        <i class="bi bi-check2-circle me-1"></i>
                                        Approve &amp; Send to Manager
                                    </button>
                                </form>
 
                            <!-- Reject -->
                                <button
                                    class="btn btn-reject btn-pill"
                                    type="button"
                                    data-bs-toggle="modal"
                                    data-bs-target="#rejectModal"
                                >
                                    <i class="bi bi-x-octagon me-1"></i>
                                    Reject Application
                                </button>
                            </div>
                            <div class="mt-2 text-muted" style="font-size: 0.8rem;">
                                Approve only when all critical documents are correctly marked as <strong>Verified</strong>.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
 
            <!-- RIGHT: Documents with Toggle -->
            <div class="col-lg-6">
                <div class="card card-modern h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-folder2-open me-2"></i> Uploaded Documents</span>
                        <span class="text-muted" style="font-size: 0.85rem;">
                            Use the toggle to mark Verified / Unverified
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            {% for doc in documents %}
                            {% set is_verified = doc.verified in (1, '1', true) %}
                            <div class="col-md-6">
                                <div class="doc-box">
                                    <div>
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="doc-title">
                                                {{ doc.document_type.replace('_', ' ').title() }}
                                            </div>
                                            <span
                                                class="badge-doc {% if is_verified %}badge-doc-verified{% else %}badge-doc-unverified{% endif %}"
                                                id="doc-status-{{ doc.id }}"
                                            >
                                                {% if is_verified %}Verified{% else %}Unverified{% endif %}
                                            </span>
                                        </div>
                                        <div class="text-muted" style="font-size: 0.8rem;">
                                            Uploaded:
                                            {% if doc.uploaded_at %}
                                                {{ doc.uploaded_at.strftime("%Y-%m-%d %H:%M") }}
                                            {% else %}
                                                —
                                            {% endif %}
                                        </div>
                                    </div>
 
                                    <div class="mt-3 d-flex flex-wrap align-items-center gap-2">
                                        <!-- Preview -->
                                        <a href="{{ url_for('agent_preview_document', doc_id=doc.id) }}"
                                           class="btn btn-outline-soft btn-sm btn-pill">
                                            <i class="bi bi-eye-fill me-1"></i> Preview
                                        </a>
 
                                        <!-- Download -->
                                        <a href="{{ url_for('agent_download_document', doc_id=doc.id) }}"
                                           class="btn btn-outline-soft btn-sm btn-pill">
                                            <i class="bi bi-download me-1"></i> Download
                                        </a>
 
                                        <!-- Toggle Verified / Unverified -->
                                        <div class="form-check form-switch ms-auto">
                                            <input
                                                class="form-check-input doc-toggle"
                                                type="checkbox"
                                                role="switch"
                                                id="toggle-{{ doc.id }}"
                                                data-id="{{ doc.id }}"
                                                {% if is_verified %}checked{% endif %}
                                            >
                                            <label class="form-check-label small" for="toggle-{{ doc.id }}">
                                                Verified
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
 
                            {% if documents|length == 0 %}
                            <div class="col-12 text-center text-muted py-4">
                                No documents uploaded for this application.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
 
        </div>
 
    </div>
</div>
 
<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form
            method="POST"
            action="{{ url_for('agent_reject_application', app_id=app.id) }}"
            class="modal-content"
        >
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-x-octagon me-1 text-danger"></i>
                    Reject Application
                </h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close">
                </button>
            </div>
 
            <div class="modal-body">
                <p class="mb-2" style="font-size: 0.9rem;">
                    Please provide a clear reason for rejection. This will be visible to the manager.
                </p>
                <label class="form-label">Reason for rejection</label>
                <textarea name="reason"
                          class="form-control"
                          rows="4"
                          required></textarea>
            </div>
 
            <div class="modal-footer">
                <button class="btn btn-outline-secondary btn-sm btn-pill"
                        type="button"
                        data-bs-dismiss="modal">
                    Cancel
                </button>
                <button class="btn btn-reject btn-sm btn-pill" type="submit">
                    Confirm Reject
                </button>
            </div>
        </form>
    </div>
</div>
 
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
 
<!-- Toggle verify/unverify script -->
<script>
document.querySelectorAll(".doc-toggle").forEach(function (toggle) {
    toggle.addEventListener("change", function () {
        const id = this.dataset.id;
        const checked = this.checked;
        const badge = document.getElementById("doc-status-" + id);
 
        this.disabled = true;
 
        fetch("/agent/document/verify/" + id, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ verified: checked ? 1 : 0 })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "success") {
                if (checked) {
                    badge.textContent = "Verified";
                    badge.classList.remove("badge-doc-unverified");
                    badge.classList.add("badge-doc-verified");
                } else {
                    badge.textContent = "Unverified";
                    badge.classList.remove("badge-doc-verified");
                    badge.classList.add("badge-doc-unverified");
                }
            } else {
                // revert change on error
                this.checked = !checked;
                alert("Failed to update document status.");
            }
        })
        .catch(err => {
            console.error(err);
            this.checked = !checked;
            alert("Error while updating document status.");
        })
        .finally(() => {
            this.disabled = false;
        });
    });
});
</script>
 
</body>
</html>
 
 