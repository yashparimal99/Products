<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Transaction History - DigiBank</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
 
  <!-- Base styles -->
  <style>
    body{ background:#f8f9fa; font-family:'Segoe UI',sans-serif; min-height:100vh; display:flex; flex-direction:column; }
    table{ width:95%; margin:0 auto 40px auto; border-collapse:collapse; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.1); border-radius:6px; overflow:hidden;}
    table th, table td{ padding:12px 15px; text-align:center; border-bottom:1px solid #ddd;}
    thead{ background:#0B4D83; color:#fff;}
    .status-success{ color:green; font-weight:600; }
    .status-failed{ color:red; font-weight:600; }
    footer.bg-custom{ background:#0B4D83; }
    .btn-action-sm { padding:.375rem .6rem; font-size:.85rem; }
  </style>
 
  <!-- Header (from Quick Transfer snippet) -->
  <style>
    .top-bar { background:#0B4D83; color:#fff; padding:10px 20px; position:sticky; top:0; z-index:1030; }
    .logout-btn { border:1.5px solid #fff; color:#fff; }
    .logout-btn:hover{ background:#fff; color:#0B4D83;}
    /* Sidebar Offcanvas */
    #sidebarMenu.offcanvas-start { width: 250px; }
    #sidebarMenu .offcanvas-body { padding: 0.5rem 1rem; }
    #sidebarMenu .nav-link { font-size: 0.9rem; padding: 8px 12px; display: flex; align-items: center; gap: 8px; color: #333; transition: color 0.3s; }
    #sidebarMenu .nav-link i { font-size: 1.1rem; }
    #sidebarMenu .nav-link.active { font-weight: 700; color: #0B4D83 !important; background-color: #f0d7e0; border-radius: 4px; }
    #sidebarMenu .nav-link:hover { color: #7a0f3e; background-color: #f9e5ef; border-radius: 4px; }
  </style>
 
  <!-- DigiBank logo styles (from Quick Transfer snippet) -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@600;700;800&display=swap');
 
    .digi-bank-logo { display: flex; align-items: center; gap: 12px; text-decoration: none; transition: transform 0.3s ease; }
    .digi-bank-logo:hover { transform: scale(1.05); }
    .logo-icon { width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 6px 18px rgba(102, 126, 234, 0.3), 0 2px 6px rgba(0, 0, 0, 0.1); }
    .logo-icon::before { content: ''; position: absolute; top: 8px; left: 8px; right: 8px; bottom: 8px; background: rgba(255, 255, 255, 0.95); border-radius: 8px; }
    .logo-icon::after { content: 'D'; position: absolute; color: transparent; background: linear-gradient(135deg, #667eea, #764ba2); background-clip: text; -webkit-background-clip: text; font-weight: 800; font-size: 20px; z-index: 2; }
    .logo-text { color: #fff; }
    .main-text { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; line-height: 1; }
    .digi { background: linear-gradient(135deg, #87CEEB 0%, #98D8E8 25%, #FFF8DC 50%, #87CEFA 100%); background-clip: text; -webkit-background-clip: text; color: transparent; text-shadow: 0 0 10px rgba(255, 255, 255, 0.3); }
    .bank { color: #ffffff; margin-left: 3px; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3); }
    .tagline { font-size: 9px; font-weight: 600; color: #e8f4f8; letter-spacing: 2px; text-transform: uppercase; margin-top: 2px; }
  </style>
</head>
<body>
 
<!-- Sidebar (from Quick Transfer snippet) -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="sidebarMenuLabel">User</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <ul class="nav flex-column">
      <li class="nav-item mb-2"><a class="nav-link text-dark active" href="{{ url_for('dashboard') }}"><i class="bi bi-speedometer2 me-2"></i> Home</a></li>
      <li class="nav-item mb-2"><a class="nav-link text-dark" href="{{ url_for('viewaccounts') }}"><i class="bi bi-person-lines-fill me-2"></i> View Accounts</a></li>
      <li class="nav-item mb-2"><a class="nav-link text-dark" href="{{ url_for('userdashloan') }}"><i class="bi bi-cash-coin me-2"></i> Loans</a></li>
      <li class="nav-item mb-2"><a class="nav-link text-dark" href="{{ url_for('Txnhistory') }}"><i class="bi bi-clock-history me-2"></i> Transaction History</a></li>
      <li class="nav-item mb-2"><a class="nav-link text-dark" href="{{ url_for('accountbal') }}"><i class="bi bi-wallet2 me-2"></i> Check Balance</a></li>
      <li class="nav-item mb-2"><a class="nav-link text-dark" href="{{ url_for('profile') }}"><i class="bi bi-gift-fill me-2"></i> Profile</a></li>
      <li class="nav-item mb-2"><a class="nav-link text-dark" href="{{ url_for('paybill') }}"><i class="bi bi-credit-card me-2"></i> Pay Bill</a></li>
      <li class="nav-item mb-2"><a class="nav-link text-dark" href="#"><i class="bi bi-person-rolodex me-2"></i> Get Contact</a></li>
      <li class="nav-item mb-2"><a class="nav-link text-dark" href="#"><i class="bi bi-shield-lock-fill me-2"></i> Privacy & Security</a></li>
    </ul>
  </div>
</div>
 
<!-- Top Bar (from Quick Transfer snippet) -->
<div class="top-bar d-flex align-items-center">
  <!-- left toggle -->
  <button class="btn btn-outline-light btn-sm me-3" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu"
          aria-controls="sidebarMenu" aria-label="Toggle sidebar">
    <i class="bi bi-list"></i>
  </button>
 
  <!-- DigiBank Logo -->
  <a class="navbar-brand digi-bank-logo" href="{{ url_for('home') }}">
    <div class="logo-icon"></div>
    <div class="logo-text">
      <div class="main-text"><span class="digi">DiGi</span><span class="bank">Bank</span></div>
      <div class="tagline">Smart Banking</div>
    </div>
  </a>
 
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #0B4D83 !important; width: 100%;">
    <div class="container-fluid">
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('dashboard') }}">My Activities</a></li>
 
          <!-- Open Account Dropdown -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="accountDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Open Account</a>
            <ul class="dropdown-menu" aria-labelledby="accountDropdown">
              <li><a class="dropdown-item" href="{{ url_for('savingform') }}">Savings Account</a></li>
              <li><a class="dropdown-item" href="{{ url_for('open_account') }}">Salary Account</a></li>
              <li><a class="dropdown-item" href="{{ url_for('open_account') }}">Current Account</a></li>
              <li><a class="dropdown-item" href="{{ url_for('open_account') }}">Safe Custody Account</a></li>
              <li><a class="dropdown-item" href="{{ url_for('open_account') }}">Pension Account</a></li>
              <li><a class="dropdown-item" href="{{ url_for('open_account') }}">PMJDY Account</a></li>
            </ul>
          </li>
 
          <!-- Deposits Dropdown -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="depositsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Deposits</a>
            <ul class="dropdown-menu" aria-labelledby="depositsDropdown">
              <li><a class="dropdown-item" href="{{ url_for('open_deposits') }}">Digital Fixed Deposits</a></li>
              <li><a class="dropdown-item" href="{{ url_for('open_deposits') }}">Fixed Deposits</a></li>
              <li><a class="dropdown-item" href="{{ url_for('open_deposits') }}">Recurring Deposits</a></li>
            </ul>
          </li>
 
          <!-- Loans Dropdown -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="loanDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Loans</a>
            <ul class="dropdown-menu" aria-labelledby="loanDropdown">
              <li><a class="dropdown-item" href="{{ url_for('open_deposits') }}">Home Loan</a></li>
              <li><a class="dropdown-item" href="{{ url_for('open_deposits') }}">Personal Loan</a></li>
              <li><a class="dropdown-item" href="{{ url_for('open_deposits') }}">Busniness Loan</a></li>
            </ul>
          </li>
 
          <!-- Cards Dropdown -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="cardDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Cards</a>
            <ul class="dropdown-menu" aria-labelledby="cardDropdown">
              <li><a class="dropdown-item" href="{{ url_for('open_cards') }}">Credit Cards</a></li>
              <li><a class="dropdown-item" href="{{ url_for('open_deposits') }}">Debit Cards</a></li>
              <li><a class="dropdown-item" href="{{ url_for('open_deposits') }}">Prepaid Cards</a></li>
            </ul>
          </li>
 
          <!-- Forex Dropdown -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="forexDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Forex</a>
            <ul class="dropdown-menu" aria-labelledby="forexDropdown">
              <li><a class="dropdown-item" href="{{ url_for('open_deposits') }}">Travel Forex Cards</a></li>
              <li><a class="dropdown-item" href="{{ url_for('open_deposits') }}">Send Money Abroad</a></li>
              <li><a class="dropdown-item" href="{{ url_for('open_deposits') }}">Send Money India</a></li>
              <li><a class="dropdown-item" href="{{ url_for('open_deposits') }}">Foregin Currency Exchange</a></li>
            </ul>
          </li>
 
          <!-- Investments Dropdown -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="investDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Investments</a>
            <ul class="dropdown-menu" aria-labelledby="investDropdown">
              <li><a class="dropdown-item" href="#">Public Provident Fund</a></li>
              <li><a class="dropdown-item" href="#">Floating Rate Saving Bonds</a></li>
              <li><a class="dropdown-item" href="#">National Pension System</a></li>
            </ul>
          </li>
        </ul>
 
        <div class="d-flex align-items-center">
          <h5 class="m-0 me-2 fs-6">Welcome, {{ user.name }} !</h5>
          <a href="{{ url_for('logout') }}" class="logout-btn btn btn-outline-light btn-sm">Logout</a>
        </div>
      </div>
    </div>
  </nav>
</div>
 
<!-- Breadcrumb (kept) -->
<nav aria-label="breadcrumb" class="mb-3 mt-3 px-3">
  <ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}" style="color:#0B4D83;">Home</a></li>
    <li class="breadcrumb-item active" aria-current="page" style="color:#0B4D83; font-weight:bold;">Transactions</li>
  </ol>
</nav>
 
<!-- Header + Filter + PDF button (content untouched) -->
<div class="section-header d-flex align-items-center px-3 position-relative" style="min-height:48px;">
  <!-- Centered title -->
  <h2 class="m-0 position-absolute start-50 translate-middle-x"
      style="top:50%; transform:translate(-50%,-50%); color:#0B4D83; font-weight:700; text-align:center;">
    Transaction History
  </h2>
 
  <!-- Right controls -->
  <div class="ms-auto d-flex align-items-center gap-2 flex-wrap">
    <div class="d-flex align-items-center gap-2 me-3">
      <label class="mb-0 me-1 small text-muted">Filter:</label>
      <select id="filterStatus" class="form-select form-select-sm" aria-label="Filter Transactions">
        <option value="all" selected>All Transactions</option>
        <option value="success">Successful</option>
        <option value="failed">Failed</option>
      </select>
    </div>
    <button id="downloadPdfBtn" class="btn btn-primary btn-action-sm">
      <i class="bi bi-file-earmark-pdf me-1"></i> Download PDF
    </button>
  </div>
</div>
 
<hr>
 
 
<!-- Table (content untouched) -->
<table id="txnTable">
  <thead>
    <tr>
      <th>Date/Time</th>
      <th>Transaction ID</th>
      <th>Type</th>
      <th>From</th>
      <th>To</th>
      <th>Amount (₹)</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
    {% for t in transactions %}
      {% set is_debit = t.from_account in my_accounts %}
      <tr data-status="{{ t.status }}">
        <td>{{ t.created_at }}</td>
        <td>{{ t.transaction_id }}</td>
        <td>
          {% if not t.from_account %}
            Deposit (Credit)
          {% elif is_debit %}
            Debit
          {% else %}
            Credit
          {% endif %}
        </td>
        <td>{{ t.from_account or '-' }}</td>
        <td>{{ t.to_account or '-' }}</td>
        <td>
          {% if not t.from_account %}
            +₹{{ '%.2f'|format(t.amount) }}
          {% elif is_debit %}
            -₹{{ '%.2f'|format(t.amount) }}
          {% else %}
            +₹{{ '%.2f'|format(t.amount) }}
          {% endif %}
        </td>
        <td class="status-{{ t.status }}">{{ t.status|capitalize }}</td>
      </tr>
    {% else %}
      <tr><td colspan="7">No transactions yet.</td></tr>
    {% endfor %}
  </tbody>
</table>
 
<footer class="bg-custom text-white text-center py-3 mt-auto">© 2025 DigiBank. All rights reserved.</footer>
 
<!-- JS libs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
 
<script>
  // Status filter (unchanged)
  const filter = document.getElementById('filterStatus');
  filter.addEventListener('change', () => {
    const val = filter.value;
    document.querySelectorAll('#txnTable tbody tr').forEach(tr => {
      if (val === 'all') { tr.style.display = ''; return; }
      tr.style.display = (tr.getAttribute('data-status') === val) ? '' : 'none';
    });
  });
 
  // Extract visible rows
  function readTableData() {
    const rows = Array.from(document.querySelectorAll('#txnTable tbody tr'))
      .filter(tr => tr.style.display !== 'none');
    return rows.map(tr => {
      const c = tr.querySelectorAll('td');
      return {
        datetime: (c[0]?.innerText || '').trim(),
        txnId:    (c[1]?.innerText || '').trim(),
        type:     (c[2]?.innerText || '').trim(),
        from:     (c[3]?.innerText || '').trim(),
        to:       (c[4]?.innerText || '').trim(),
        amountRaw:(c[5]?.innerText || '').trim(), // may contain ₹ and commas
        status:   (c[6]?.innerText || '').trim()
      };
    });
  }
 
  // Parse "+₹1,23,456.78" / "-₹500.00" -> number, and format ASCII (avoid ₹ font issues in PDF)
  function parseAmountToNumber(str){
    if(!str) return 0;
    const s = str.trim();
    const sign = s.startsWith('-') ? -1 : 1;
    const num = parseFloat(s.replace(/[^\d.]/g,'') || '0');
    return sign * num;
  }
  function fmtAmountINR(num){
    const sign = num < 0 ? '-' : '';
    const abs  = Math.abs(num);
    const txt  = abs.toLocaleString('en-IN',{minimumFractionDigits:2, maximumFractionDigits:2});
    return `${sign}${txt}`;
  }
 
  // PDF download — minimal header, centered table, auto-fit columns
  function downloadPDF(filename) {
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) { alert("PDF library failed to load."); return; }
 
    const doc  = new jsPDF({ orientation:'p', unit:'pt', format:'a4' });
    const data = readTableData();
 
    // Minimal, centered title
    const pageW = doc.internal.pageSize.getWidth();
    doc.setFont('helvetica','bold');
    doc.setFontSize(12);
    doc.text("Transaction Statement", pageW/2, 40, { align: 'center' });
 
    // Table data
    const head = [["Date/Time","Transaction ID","Type","From","To","Amount","Status"]];
    const body = data.map(r => {
      const n = parseAmountToNumber(r.amountRaw);
      return [ r.datetime, r.txnId, r.type, r.from, r.to, fmtAmountINR(n), r.status ];
    });
 
    doc.autoTable({
      head, body,
      startY: 60,
      tableWidth: 'auto',
      margin: { left: 40, right: 40 },  // equal margins -> centered
      styles: { fontSize: 9, valign: 'middle', overflow: 'linebreak', cellPadding: 4 },
      headStyles: { fillColor: [11,77,131], textColor: 255, halign: 'center' },
      bodyStyles: { halign: 'center' },
      columnStyles: { 5: { halign: 'right', fontStyle: 'bold' } }, // Amount neat/right
      didDrawPage: (dataArg) => {
        const pageSize = doc.internal.pageSize;
        const h = pageSize.height || pageSize.getHeight();
        doc.setFontSize(9);
        doc.text(`© 2025 DigiBank`, 40, h - 20);
        const pages = doc.internal.getNumberOfPages();
        doc.text(`Page ${dataArg.pageNumber} of ${pages}`, pageSize.width - 100, h - 20);
      }
    });
 
    doc.save(filename);
  }
 
  // Button
  document.getElementById('downloadPdfBtn')?.addEventListener('click', () => {
    const when = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    downloadPDF(`DigiBank_Transaction_Statement_${when}.pdf`);
  });
</script>
</body>
</html>
 
 