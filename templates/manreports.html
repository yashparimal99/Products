<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Report & Analytics — DigiBank</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
 
  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
 
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
 
  <style>
    :root{
      --brand:#97144D;      /* HDFC-ish maroon you use */
      --brand-2:#0B4D83;    /* Deep blue you use */
      --bg:#f4f6f9;
      --card:#ffffff;
      --ink:#212529;
      --muted:#6c757d;
      --ok:#22c55e;         /* Approved */
      --pend:#f59e0b;       /* Pending  */
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0e1116;
        --card:#151a21;
        --ink:#f1f5f9;
        --muted:#9aa4b2;
      }
      .form-select, .btn-outline-light { color:#e6eef7; }
    }
    html,body{ height:100%; }
    body{
      background: radial-gradient(1200px 600px at 10% -10%, rgba(151,20,77,0.08), transparent 60%),
                  radial-gradient(900px 500px at 100% 0%, rgba(11,77,131,0.08), transparent 60%),
                  var(--bg);
      font-family: 'Segoe UI', system-ui, -apple-system, Roboto, sans-serif;
      color:var(--ink);
      display:flex; flex-direction:column;
      min-height:100vh;
    }
 
    /* Top bar */
    .top-bar{
      background:linear-gradient(90deg, var(--brand), var(--brand-2));
      color:#fff; padding:.75rem 1rem; position:sticky; top:0; z-index:1030;
      box-shadow:0 4px 20px rgba(0,0,0,.15);
    }
    .logout-btn{
      background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.35);
      color:#fff; padding:6px 14px; border-radius:100px; font-weight:600;
      backdrop-filter: blur(6px);
    }
    .logout-btn:hover{ background:#fff; color:var(--brand); }
 
    /* Cards */
    .glass-card{
      background:linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.90)) ;
      backdrop-filter: blur(6px);
      border-radius:18px; border:1px solid rgba(0,0,0,.06);
      box-shadow:0 10px 30px rgba(0,0,0,.08);
      overflow:hidden;
    }
    @media (prefers-color-scheme: dark){
      .glass-card{
        background:linear-gradient(180deg, rgba(21,26,33,.7), rgba(21,26,33,.95));
        border-color:rgba(255,255,255,.06);
      }
    }
    .card-head{
      background:linear-gradient(90deg, rgba(151,20,77,.95), rgba(11,77,131,.95));
      color:#fff; padding:.8rem 1rem;
      display:flex; align-items:center; justify-content:space-between;
    }
    .badge-soft{
      background: rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.35);
      color:#fff; border-radius:999px; padding:.25rem .6rem; font-size:.78rem;
    }
    .chart-wrap{ height:380px; padding:16px; background:transparent; }
 
    /* Controls row */
    .toolbar{
      background:var(--card);
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      box-shadow:0 8px 24px rgba(0,0,0,.06);
      padding:12px; margin-top:14px;
    }
 
    /* Skeleton loader */
    .skeleton{
      position:relative; overflow:hidden; border-radius:12px; height:360px; background:linear-gradient(90deg, rgba(0,0,0,.06), rgba(0,0,0,.03), rgba(0,0,0,.06));
    }
    .skeleton::after{
      content:""; position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
      transform: translateX(-100%);
      animation: shimmer 1.4s infinite;
    }
    @keyframes shimmer{ 100%{ transform: translateX(100%);} }
 
    /* Button pills */
    .btn-pill{ border-radius:999px; }
 
    footer{
      background:linear-gradient(90deg, var(--brand), var(--brand-2)); color:#fff; margin-top:auto;
    }
  </style>
</head>
<body>
 
  <!-- Top Bar -->
  <div class="top-bar d-flex align-items-center">
    <button class="btn btn-outline-light btn-sm me-3" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu">
      <i class="bi bi-list"></i>
    </button>
    <h5 class="me-auto mb-0"><i class="bi bi-graph-up-arrow me-2"></i> Report & Analytics</h5>
    <a class="logout-btn ms-3" href="{{ url_for('logout') }}">Logout</a>
  </div>
 
  <!-- Sidebar -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="sidebarMenuLabel">Manager</h5>
      <button class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="nav flex-column">
        <li class="nav-item mb-2">
          <a class="nav-link text-dark" href="{{ url_for('branchperformance') }}"><i class="bi bi-building me-2"></i> Branch Performance</a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link text-dark active" href="{{ url_for('manreport') }}"><i class="bi bi-graph-up-arrow me-2"></i> Report & Analytics</a>
        </li>
      </ul>
    </div>
  </div>
 
  <!-- Controls -->
  <div class="container">
    <div class="toolbar d-flex flex-wrap gap-2 align-items-center">
      <div class="d-flex align-items-center gap-2">
        <span class="text-muted small">City</span>
        <select id="citySelect" class="form-select form-select-sm" style="min-width:220px">
          <option value="">All Cities</option>
        </select>
      </div>
 
      <div class="ms-auto d-flex gap-2">
        <button id="refreshBtn" class="btn btn-primary btn-sm btn-pill">
          <i class="bi bi-arrow-repeat me-1"></i> Refresh
        </button>
        <button id="exportAllPng" class="btn btn-outline-primary btn-sm btn-pill">
          <i class="bi bi-image me-1"></i> Download Charts
        </button>
      </div>
    </div>
  </div>
 
  <!-- Charts -->
  <div class="container my-3">
    <div class="row g-4">
      <!-- Accounts -->
      <div class="col-12 glass-card">
        <div class="card-head">
          <div><i class="bi bi-person-lines-fill me-2"></i> <strong>Accounts</strong> — Approved vs Pending</div>
          <div class="d-flex align-items-center gap-2">
            <span class="badge-soft"><i class="bi bi-check2-circle me-1"></i> Approved</span>
            <span class="badge-soft"><i class="bi bi-hourglass-split me-1"></i> Pending</span>
            <button class="btn btn-light btn-sm btn-pill" data-dl="barAccounts"><i class="bi bi-download"></i></button>
          </div>
        </div>
        <div class="chart-wrap">
          <div class="skeleton" id="sk-acc"></div>
          <canvas id="barAccounts" class="d-none"></canvas>
        </div>
      </div>
 
      <!-- Deposits -->
      <div class="col-12 glass-card">
        <div class="card-head">
          <div><i class="bi bi-piggy-bank me-2"></i> <strong>Deposits</strong> — Approved vs Pending</div>
          <div class="d-flex align-items-center gap-2">
            <span class="badge-soft"><i class="bi bi-check2-circle me-1"></i> Approved</span>
            <span class="badge-soft"><i class="bi bi-hourglass-split me-1"></i> Pending</span>
            <button class="btn btn-light btn-sm btn-pill" data-dl="barDeposits"><i class="bi bi-download"></i></button>
          </div>
        </div>
        <div class="chart-wrap">
          <div class="skeleton" id="sk-dep"></div>
          <canvas id="barDeposits" class="d-none"></canvas>
        </div>
      </div>
 
      <!-- Loans -->
      <div class="col-12 glass-card">
        <div class="card-head">
          <div><i class="bi bi-house-door me-2"></i> <strong>Loans</strong> — Approved vs Pending</div>
          <div class="d-flex align-items-center gap-2">
            <span class="badge-soft"><i class="bi bi-check2-circle me-1"></i> Approved</span>
            <span class="badge-soft"><i class="bi bi-hourglass-split me-1"></i> Pending</span>
            <button class="btn btn-light btn-sm btn-pill" data-dl="barLoans"><i class="bi bi-download"></i></button>
          </div>
        </div>
        <div class="chart-wrap">
          <div class="skeleton" id="sk-loan"></div>
          <canvas id="barLoans" class="d-none"></canvas>
        </div>
      </div>
 
      <!-- Cards -->
      <div class="col-12 glass-card">
        <div class="card-head">
          <div><i class="bi bi-credit-card-2-front me-2"></i> <strong>Cards</strong> — Approved vs Pending</div>
          <div class="d-flex align-items-center gap-2">
            <span class="badge-soft"><i class="bi bi-check2-circle me-1"></i> Approved</span>
            <span class="badge-soft"><i class="bi bi-hourglass-split me-1"></i> Pending</span>
            <button class="btn btn-light btn-sm btn-pill" data-dl="barCards"><i class="bi bi-download"></i></button>
          </div>
        </div>
        <div class="chart-wrap">
          <div class="skeleton" id="sk-card"></div>
          <canvas id="barCards" class="d-none"></canvas>
        </div>
      </div>
 
      <!-- Investments -->
      <div class="col-12 glass-card">
        <div class="card-head">
          <div><i class="bi bi-cash-coin me-2"></i> <strong>Investments</strong> — Approved vs Pending</div>
          <div class="d-flex align-items-center gap-2">
            <span class="badge-soft"><i class="bi bi-check2-circle me-1"></i> Approved</span>
            <span class="badge-soft"><i class="bi bi-hourglass-split me-1"></i> Pending</span>
            <button class="btn btn-light btn-sm btn-pill" data-dl="barInvestments"><i class="bi bi-download"></i></button>
          </div>
        </div>
        <div class="chart-wrap">
          <div class="skeleton" id="sk-inv"></div>
          <canvas id="barInvestments" class="d-none"></canvas>
        </div>
      </div>
    </div>
  </div>
 
  <footer class="py-3 text-center">
    © 2025 DigiBank. All rights reserved.
  </footer>
 
  <!-- Toast -->
  <div class="toast-container position-fixed top-0 end-0 p-3"></div>
 
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const charts = {};
    const loaders = {
      acc: ['sk-acc','barAccounts'],
      dep: ['sk-dep','barDeposits'],
      loan:['sk-loan','barLoans'],
      card:['sk-card','barCards'],
      inv: ['sk-inv','barInvestments']
    };
 
    function showToast(msg, type='info'){
      const box=document.querySelector('.toast-container');
      const t=document.createElement('div');
      t.className=`toast text-bg-${type==='success'?'success':type==='warning'?'warning':type==='danger'?'danger':'info'} border-0`;
      t.setAttribute('role','alert'); t.setAttribute('aria-live','assertive'); t.setAttribute('aria-atomic','true');
      t.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div><button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      box.appendChild(t);
      const bs=new bootstrap.Toast(t,{autohide:true,delay:2200}); bs.show();
      t.addEventListener('hidden.bs.toast',()=>t.remove());
    }
 
    document.addEventListener('DOMContentLoaded', async () => {
      await loadCities();
      initCharts();
      wireDownloads();
      await refreshCharts();
      document.getElementById('refreshBtn').addEventListener('click', refreshCharts);
      document.getElementById('citySelect').addEventListener('change', refreshCharts);
      document.getElementById('exportAllPng').addEventListener('click', downloadAllCharts);
    });
 
    async function loadCities(){
      try{
        const res=await fetch('/api/perf/cities');
        const cities=await res.json();
        const sel=document.getElementById('citySelect');
        (cities||[]).forEach(c=>{
          const opt=document.createElement('option');
          opt.value=c; opt.textContent=c; sel.appendChild(opt);
        });
      }catch(e){}
    }
 
    function activeCity(){ return document.getElementById('citySelect')?.value || ''; }
 
    function initCharts(){
      // Rounded bar helper
      const common = {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ position:'bottom' },
          tooltip:{ enabled:true }
        },
        scales:{
          y:{ beginAtZero:true, ticks:{ precision:0 } },
          x:{ ticks:{ autoSkip:false } }
        }
      };
 
      const dataset = (label,isApproved) => ({
        label,
        data:[],
        borderWidth:0,
        borderRadius:8,
        backgroundColor: isApproved
            ? getApprovedGradient
            : getPendingGradient,
        hoverBackgroundColor: isApproved
            ? 'rgba(34,197,94,.9)'
            : 'rgba(245,158,11,.9)'
      });
 
      charts.acc = new Chart(document.getElementById('barAccounts'), {
        type:'bar',
        data:{ labels:[], datasets:[ dataset('Approved',true), dataset('Pending',false) ] },
        options: common
      });
      charts.dep = new Chart(document.getElementById('barDeposits'), {
        type:'bar',
        data:{ labels:[], datasets:[ dataset('Approved',true), dataset('Pending',false) ] },
        options: common
      });
      charts.loan = new Chart(document.getElementById('barLoans'), {
        type:'bar',
        data:{ labels:[], datasets:[ dataset('Approved',true), dataset('Pending',false) ] },
        options: common
      });
      charts.card = new Chart(document.getElementById('barCards'), {
        type:'bar',
        data:{ labels:[], datasets:[ dataset('Approved',true), dataset('Pending',false) ] },
        options: common
      });
      charts.inv = new Chart(document.getElementById('barInvestments'), {
        type:'bar',
        data:{ labels:[], datasets:[ dataset('Approved',true), dataset('Pending',false) ] },
        options: common
      });
    }
 
    // Nice gradients for bars
    function getApprovedGradient(ctx){
      const {ctx:cx, chartArea} = ctx.chart;
      if(!chartArea) return 'rgba(34,197,94,.8)';
      const g = cx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
      g.addColorStop(0, 'rgba(34,197,94,.35)');
      g.addColorStop(.7, 'rgba(34,197,94,.85)');
      return g;
    }
    function getPendingGradient(ctx){
      const {ctx:cx, chartArea} = ctx.chart;
      if(!chartArea) return 'rgba(245,158,11,.8)';
      const g = cx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
      g.addColorStop(0, 'rgba(245,158,11,.35)');
      g.addColorStop(.7, 'rgba(245,158,11,.85)');
      return g;
    }
 
    function toggleSkeleton(show){
      const set = (key, on) => {
        const [sk,cnv] = loaders[key];
        const s = document.getElementById(sk);
        const c = document.getElementById(cnv);
        if(on){ s.classList.remove('d-none'); c.classList.add('d-none'); }
        else { s.classList.add('d-none'); c.classList.remove('d-none'); }
      };
      ['acc','dep','loan','card','inv'].forEach(k => set(k, show));
    }
 
    async function refreshCharts(){
      try{
        toggleSkeleton(true);
        const city = activeCity();
        const d = await (await fetch(`/api/report/approval_breakdown?city=${encodeURIComponent(city)}`)).json();
 
        // Accounts
        charts.acc.data.labels = d.accounts.labels || [];
        charts.acc.data.datasets[0].data = d.accounts.approved || [];
        charts.acc.data.datasets[1].data = d.accounts.pending || [];
        charts.acc.update();
 
        // Deposits
        charts.dep.data.labels = d.deposits.labels || [];
        charts.dep.data.datasets[0].data = d.deposits.approved || [];
        charts.dep.data.datasets[1].data = d.deposits.pending || [];
        charts.dep.update();
 
        // Loans
        charts.loan.data.labels = d.loans.labels || [];
        charts.loan.data.datasets[0].data = d.loans.approved || [];
        charts.loan.data.datasets[1].data = d.loans.pending || [];
        charts.loan.update();
 
        // Cards
        charts.card.data.labels = d.cards.labels || [];
        charts.card.data.datasets[0].data = d.cards.approved || [];
        charts.card.data.datasets[1].data = d.cards.pending || [];
        charts.card.update();
 
        // Investments
        charts.inv.data.labels = d.investments.labels || [];
        charts.inv.data.datasets[0].data = d.investments.approved || [];
        charts.inv.data.datasets[1].data = d.investments.pending || [];
        charts.inv.update();
 
        toggleSkeleton(false);
        showToast(`Updated ${city?('· '+city):''}`,'success');
      }catch(e){
        console.error(e);
        toggleSkeleton(false);
        showToast('Failed to load Report & Analytics','danger');
      }
    }
 
    function wireDownloads(){
      document.querySelectorAll('[data-dl]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-dl');
          const canvas = document.getElementById(id);
          const a = document.createElement('a');
          a.href = canvas.toDataURL('image/png', 1.0);
          a.download = `${id}_${new Date().toISOString().slice(0,10)}.png`;
          a.click();
        });
      });
    }
 
    function downloadAllCharts(){
      ['barAccounts','barDeposits','barLoans','barCards','barInvestments'].forEach(id=>{
        const canvas=document.getElementById(id);
        const a=document.createElement('a');
        a.href=canvas.toDataURL('image/png',1.0);
        a.download = `${id}_${new Date().toISOString().slice(0,10)}.png`;
        a.click();
      });
    }
  </script>
</body>
</html>
 
 