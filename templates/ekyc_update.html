<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Update e-KYC - DigiBank</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body{background-color:#f8f9fa;font-family:'Segoe UI',sans-serif;}
    .top-bar{background:#0B4D83;color:#fff;display:flex;align-items:center;gap:12px;padding:10px 20px;position:sticky;top:0;z-index:1030;}
    .digi-bank-logo{display:flex;align-items:center;gap:12px;text-decoration:none;color:#fff;}
    .logo-icon{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#667eea,#764ba2,#f093fb,#4facfe);box-shadow:0 6px 16px rgba(0,0,0,.15);}
    .main-text{font-size:20px;font-weight:800;}
    .tagline{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#e8f4f8;}
    .form-section{background:#fff;border-radius:10px;box-shadow:0 4px 14px rgba(0,0,0,.08);padding:26px;margin:24px auto;max-width:880px;}
    h3{color:#0B4D83;font-weight:700;}
    .btn-submit{background:#0B4D83;color:#fff;font-weight:600;border:none;border-radius:5px;padding:10px 0;}
    .btn-submit:hover{background:#7a0f3e;}
    .btn-verify,.btn-view,.btn-capture,.btn-ghost{background:#0B4D83;color:#fff;border:none;border-radius:6px;padding:7px 16px;font-size:.9rem;}
    .btn-verify:hover,.btn-view:hover,.btn-capture:hover,.btn-ghost:hover{background:#7a0f3e;}
    .btn-ghost{background:#eef2f7;color:#0B4D83;border:1px solid #d6dee8;}
    .identity-section{background:#f9f7f2;padding:16px;border-radius:8px;margin-top:10px;}
    .identity-section h5{color:#0B4D83;font-weight:700;margin-bottom:10px;text-align:center;}
    .verified{font-size:.85rem;margin-top:6px;display:block;min-height:22px;}
    .preview-img{max-width:100%;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,.15);}
    video{width:100%;border-radius:8px;display:none;margin-top:10px;}
    canvas{display:none;}
    .hint{font-size:.8rem;color:#6b7280}
    .pill{display:inline-block;background:#eef2f7;color:#0B4D83;border:1px solid #d6dee8;border-radius:999px;padding:4px 10px;font-size:.8rem}
    .otp-boxes{display:flex;gap:8px;margin-top:6px}
    .otp-boxes input{
      width:44px;height:48px;border:1px solid #d6dee8;border-radius:8px;
      text-align:center;font-size:1.1rem;font-weight:700;outline:none;
    }
    .otp-boxes input:focus{border-color:#0B4D83;box-shadow:0 0 0 3px rgba(11,77,131,.15);}
    .otp-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .otp-mini-hint{font-size:.8rem;color:#6b7280}
    .toast-container{position:fixed;top:12px;right:12px;z-index:2000}
    .otp-toast .toast-header{background:#0B4D83;color:#fff}
    .otp-badge{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-weight:800; letter-spacing:2px; font-size:1.1rem;}
  </style>
</head>
<body>
 
<div class="top-bar">
  <a class="digi-bank-logo" href="{{ url_for('home') }}">
    <div class="logo-icon"></div>
    <div>
      <div class="main-text">DiGiBank</div>
      <div class="tagline">Smart Banking</div>
    </div>
  </a>
  <div class="ms-auto d-flex align-items-center gap-2">
    <span class="small">Welcome, {{ user.name }}!</span>
    <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">Logout</a>
  </div>
</div>
 
<!-- OTP CENTER -->
<div class="toast-container" id="otpToastContainer"></div>
 
<nav aria-label="breadcrumb" class="px-3 pt-2">
  <ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a href="{{ url_for('profile') }}" style="color:#0B4D83;">Profile</a></li>
    <li class="breadcrumb-item active" style="color:#0B4D83;font-weight:600;">Update e-KYC</li>
  </ol>
</nav>
 
<div class="container">
  <div class="form-section">
    {% if ekyc %}
      {% set st = (ekyc.status or '').lower() %}
      {% if st == 'approved' %}
        <div class="alert alert-success d-flex justify-content-between align-items-center mb-3">
          <div>
            <i class="bi bi-shield-check me-2"></i>
            Your e-KYC is <strong>verified</strong>.
            {% if ekyc.updated_at %} Updated at: {{ ekyc.updated_at }}{% endif %}
          </div>
        </div>
      {% elif st == 'pending' %}
        <div class="alert alert-info mb-3">
          <i class="bi bi-hourglass-split me-1"></i>
          Your latest e-KYC submission is <strong>pending</strong> officer approval.
        </div>
      {% elif st == 'rejected' %}
        <div class="alert alert-warning mb-3">
          <i class="bi bi-exclamation-triangle me-1"></i>
          Your previous e-KYC was <strong>rejected</strong>. Please resubmit correct details below.
        </div>
      {% endif %}
    {% endif %}
 
    <h3 class="text-center mb-3">Update Your e-KYC Details</h3>
    <p class="text-muted text-center mb-4">
      Upload your latest photo and verify your Aadhaar & PAN. Mobile number is required but has no OTP.
      OTP shown here is for demo; final verification is done by an officer.
    </p>
 
    <form id="ekycForm" action="{{ url_for('updateekyc') }}" method="POST" enctype="multipart/form-data"
          {% if ekyc and (ekyc.status or '').lower() == 'approved' %}onsubmit="return false;"{% endif %}>
      {% if not (ekyc and (ekyc.status or '').lower() == 'approved') %}
 
      <!-- Hidden flags (Aadhaar & PAN only) -->
      <input type="hidden" name="aadhaar_otp_verified" id="aadhaarOtpVerified" value="0">
      <input type="hidden" name="pan_otp_verified" id="panOtpVerified" value="0">
 
      <!-- Passport Photo -->
      <div class="mb-4">
        <label class="form-label">Upload or Capture Passport Photo <span class="text-danger">*</span></label>
        <input type="file" class="form-control" name="passport_photo" id="passportPhoto" accept="image/*" required>
        <div class="d-flex flex-wrap gap-2 mt-2">
          <button type="button" class="btn-view" id="viewPhotoBtn">View</button>
          <button type="button" class="btn-capture" id="openCameraBtn">Capture Live</button>
          <button type="button" class="btn-capture" id="capturePhotoBtn" style="display:none;">Take Snapshot</button>
        </div>
        <video id="cameraStream" autoplay></video>
        <canvas id="capturedCanvas"></canvas>
      </div>
 
      <!-- Mobile (NO OTP, value required but no format validation) -->
      <div class="mb-4">
        <label class="form-label">Mobile Number <span class="text-danger">*</span></label>
        <input type="text" class="form-control" id="mobileNumber" name="mobile_number"
               placeholder="Enter Mobile Number" required>
        <small class="text-muted">Enter any mobile number; no OTP will be sent.</small>
      </div>
 
      <!-- Aadhaar -->
      <div class="identity-section mb-3">
        <h5><i class="bi bi-person-vcard me-2"></i>Aadhaar Verification</h5>
 
        <label class="form-label">Aadhaar Number <span class="text-danger">*</span></label>
        <input type="text" class="form-control" id="aadharNumber" name="aadhar_number"
               placeholder="Enter 12-digit Aadhaar" maxlength="12" required>
        <span id="aadharStatus" class="verified"></span>
 
        <div class="otp-actions">
          <button type="button" id="aadhaarSendOtp" class="btn-verify" disabled>Send OTP</button>
          <span id="aadhaarTimer" class="otp-mini-hint"></span>
        </div>
 
        <div class="otp-boxes" id="aadhaarOtpBoxes">
          <input maxlength="1" inputmode="numeric" disabled>
          <input maxlength="1" inputmode="numeric" disabled>
          <input maxlength="1" inputmode="numeric" disabled>
          <input maxlength="1" inputmode="numeric" disabled>
          <input maxlength="1" inputmode="numeric" disabled>
          <input maxlength="1" inputmode="numeric" disabled>
        </div>
 
        <div class="otp-actions">
          <button type="button" id="aadhaarVerifyOtp" class="btn-ghost" disabled>Verify</button>
          <div id="aadhaarOtpHint" class="otp-mini-hint"></div>
        </div>
      </div>
 
      <!-- PAN -->
      <div class="identity-section mb-3">
        <h5><i class="bi bi-credit-card-2-front me-2"></i>PAN Verification</h5>
 
        <label class="form-label">PAN Number <span class="text-danger">*</span></label>
        <input type="text" class="form-control" id="panNumber" name="pan_number"
               placeholder="Enter PAN (ABCDE1234F)" maxlength="10" required>
        <span id="panStatus" class="verified"></span>
 
        <div class="otp-actions">
          <button type="button" id="panSendOtp" class="btn-verify" disabled>Send OTP</button>
          <span id="panTimer" class="otp-mini-hint"></span>
        </div>
 
        <div class="otp-boxes" id="panOtpBoxes">
          <input maxlength="1" inputmode="numeric" disabled>
          <input maxlength="1" inputmode="numeric" disabled>
          <input maxlength="1" inputmode="numeric" disabled>
          <input maxlength="1" inputmode="numeric" disabled>
          <input maxlength="1" inputmode="numeric" disabled>
          <input maxlength="1" inputmode="numeric" disabled>
        </div>
 
        <div class="otp-actions">
          <button type="button" id="panVerifyOtp" class="btn-ghost" disabled>Verify</button>
          <div id="panOtpHint" class="otp-mini-hint"></div>
        </div>
      </div>
 
      <div class="text-center">
        <button type="submit" class="btn-submit w-50">Submit e-KYC for Review</button>
      </div>
      {% else %}
      <div class="text-center mt-3">
        <span class="badge bg-success px-3 py-2">
          <i class="bi bi-shield-lock-fill me-1"></i> e-KYC already verified
        </span>
      </div>
      {% endif %}
    </form>
  </div>
</div>
 
<!-- Preview modal -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow">
      <div class="modal-header text-white" style="background:#0B4D83;">
        <h5 class="modal-title"><i class="bi bi-card-image me-2"></i>Photo Preview</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="previewImage" src="" class="preview-img" alt="Preview">
      </div>
    </div>
  </div>
</div>
 
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ====== CONFIG ====== */
const SHOW_TEST_OTP = true;   // show OTP in toast (demo)
const OTP_LENGTH = 6;
const RESEND_SECONDS = 30;
 
/* ====== Camera & Preview ====== */
const previewModal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
const passportPhotoInput = document.getElementById('passportPhoto');
const previewImage = document.getElementById('previewImage');
const video = document.getElementById('cameraStream');
const canvas = document.getElementById('capturedCanvas');
const openCameraBtn = document.getElementById('openCameraBtn');
const capturePhotoBtn = document.getElementById('capturePhotoBtn');
let stream = null;
 
document.getElementById('viewPhotoBtn').addEventListener('click', () => {
  const file = passportPhotoInput.files[0];
  if (!file) { alert('Please upload or capture a photo first.'); return; }
  const r = new FileReader();
  r.onload = e => { previewImage.src = e.target.result; previewModal.show(); };
  r.readAsDataURL(file);
});
 
openCameraBtn.addEventListener('click', async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject = stream;
    video.style.display = 'block';
    capturePhotoBtn.style.display = 'inline-block';
  } catch(e){ alert('Camera access denied or unavailable.'); }
});
 
capturePhotoBtn.addEventListener('click', () => {
  if(!stream) return;
  const ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  stream.getTracks().forEach(t=>t.stop());
  video.style.display='none';
  capturePhotoBtn.style.display='none';
  canvas.toBlob(blob => {
    const file = new File([blob],'captured_photo.png',{type:'image/png'});
    const dt = new DataTransfer();
    dt.items.add(file);
    passportPhotoInput.files = dt.files;
    const r = new FileReader();
    r.onload = e => { previewImage.src = e.target.result; previewModal.show(); };
    r.readAsDataURL(file);
  });
});
 
/* ====== Helpers ====== */
const digitsOnly = s => s.replace(/\D/g,'');
const isValidAadhaar = s => /^\d{12}$/.test(s) && !/^0+$/.test(s);
const isValidPAN = s => /^[A-Z]{5}\d{4}[A-Z]$/.test(s);
function genOtp(len=OTP_LENGTH){ let x=''; for(let i=0;i<len;i++) x += Math.floor(Math.random()*10); return x; }
function startTimer(spanEl, btnEl, seconds=RESEND_SECONDS){
  let s = seconds;
  btnEl.disabled = true;
  spanEl.textContent = `Resend in ${s}s`;
  const id = setInterval(()=>{
    s--;
    if(s<=0){ clearInterval(id); spanEl.textContent=''; btnEl.disabled=false; }
    else { spanEl.textContent = `Resend in ${s}s`; }
  },1000);
}
 
/* ====== OTP CENTER (toasts) ====== */
const toastContainer = document.getElementById('otpToastContainer');
function showOtpToast(kind, code){
  if(!SHOW_TEST_OTP) return;
  const id = `toast-${kind}-${Date.now()}`;
  const wrapper = document.createElement('div');
  wrapper.className = 'toast otp-toast';
  wrapper.id = id;
  wrapper.setAttribute('role','alert');
  wrapper.setAttribute('aria-live','assertive');
  wrapper.setAttribute('aria-atomic','true');
 
  wrapper.innerHTML = `
    <div class="toast-header">
      <i class="bi bi-key me-2"></i>
      <strong class="me-auto">OTP Center</strong>
      <small class="text-white text-opacity-75">${kind.toUpperCase()}</small>
      <button type="button" class="btn-close btn-close-white ms-2 mb-1" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body d-flex align-items-center justify-content-between gap-3">
      <div>Use this OTP:</div>
      <div class="otp-badge">${code}</div>
      <button class="btn btn-sm btn-light" data-copy="${code}">
        <i class="bi bi-clipboard"></i> Copy
      </button>
    </div>`;
  toastContainer.appendChild(wrapper);
  const t = new bootstrap.Toast(wrapper, { delay: 8000 });
  t.show();
  wrapper.querySelector('[data-copy]').addEventListener('click', (e)=>{
    navigator.clipboard.writeText(e.currentTarget.getAttribute('data-copy'));
    e.currentTarget.innerHTML = '<i class="bi bi-clipboard-check"></i> Copied';
    setTimeout(()=>{ e.currentTarget.innerHTML = '<i class="bi bi-clipboard"></i> Copy'; }, 1500);
  });
}
 
/* ====== OTP Boxes binder ====== */
function bindOtpBoxes(containerId){
  const boxWrap = document.getElementById(containerId);
  const inputs = Array.from(boxWrap.querySelectorAll('input'));
  function readValue(){ return inputs.map(i=>i.value.trim()).join(''); }
  function clearAll(){ inputs.forEach(i=>i.value=''); if(!inputs[0].disabled) inputs[0].focus(); }
  inputs.forEach((inp, idx)=>{
    inp.addEventListener('input', ()=>{
      inp.value = inp.value.replace(/\D/g,'').slice(0,1);
      if(inp.value && idx < inputs.length-1) inputs[idx+1].focus();
    });
    inp.addEventListener('keydown', (e)=>{
      if(e.key === 'Backspace' && !inp.value && idx>0){
        inputs[idx-1].focus(); inputs[idx-1].value='';
      }
      if(e.key === 'ArrowLeft' && idx>0) inputs[idx-1].focus();
      if(e.key === 'ArrowRight' && idx<inputs.length-1) inputs[idx+1].focus();
    });
    inp.addEventListener('paste',(e)=>{
      const text = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g,'').slice(0,inputs.length);
      if(!text) return;
      e.preventDefault();
      inputs.forEach((x,i)=> x.value = text[i] || '');
    });
  });
  return {
    enable(){ inputs.forEach(i=>i.disabled=false); inputs[0].focus(); },
    disable(){ inputs.forEach(i=>i.disabled=true); },
    readValue,
    clearAll
  };
}
 
const aadhaarOtpUI = bindOtpBoxes('aadhaarOtpBoxes');
const panOtpUI     = bindOtpBoxes('panOtpBoxes');
 
/* ====== State ====== */
let aadhaarOtp = null, panOtp = null;
 
/* ====== Elements ====== */
const mobileNumber = document.getElementById('mobileNumber');
 
const aadharNumber = document.getElementById('aadharNumber');
const aadharStatus = document.getElementById('aadharStatus');
const aadhaarSendOtp = document.getElementById('aadhaarSendOtp');
const aadhaarVerifyOtp = document.getElementById('aadhaarVerifyOtp');
const aadhaarTimer = document.getElementById('aadhaarTimer');
const aadhaarOtpHint = document.getElementById('aadhaarOtpHint');
const aadhaarOtpVerifiedField = document.getElementById('aadhaarOtpVerified');
 
const panNumber = document.getElementById('panNumber');
const panStatus = document.getElementById('panStatus');
const panSendOtp = document.getElementById('panSendOtp');
const panVerifyOtp = document.getElementById('panVerifyOtp');
const panTimer = document.getElementById('panTimer');
const panOtpHint = document.getElementById('panOtpHint');
const panOtpVerifiedField = document.getElementById('panOtpVerified');
 
/* ====== Enable Aadhaar/PAN OTP only after mobile has some value ====== */
function toggleOtpButtons(){
  const hasMobile = mobileNumber.value.trim().length > 0;
  aadhaarSendOtp.disabled = !hasMobile;
  panSendOtp.disabled = !hasMobile;
}
mobileNumber.addEventListener('input', toggleOtpButtons);
toggleOtpButtons();
 
/* ====== Aadhaar events ====== */
aadharNumber.addEventListener('input', ()=>{
  aadharNumber.value = digitsOnly(aadharNumber.value).slice(0,12);
  const ok = isValidAadhaar(aadharNumber.value);
  aadharStatus.innerHTML = ok ? '<span class="text-success"><i class="bi bi-check-circle"></i> Looks valid</span>'
                              : '<span class="text-danger">Enter 12 digits</span>';
  if(!ok){
    aadhaarOtpUI.disable(); aadhaarOtpUI.clearAll();
    aadhaarVerifyOtp.disabled = true; aadhaarOtpHint.textContent='';
    aadhaarOtpVerifiedField.value = '0';
  }
});
 
aadhaarSendOtp.addEventListener('click', ()=>{
  if(!isValidAadhaar(aadharNumber.value)){ aadharStatus.innerHTML='<span class="text-danger">Enter valid 12-digit Aadhaar</span>'; return; }
  aadhaarOtp = genOtp();
  aadhaarOtpUI.enable();
  aadhaarVerifyOtp.disabled = false;
  aadharStatus.innerHTML = '<span class="text-primary"><i class="bi bi-send"></i> OTP sent</span>';
  if(SHOW_TEST_OTP){ aadhaarOtpHint.textContent = 'On-screen OTP shown above'; showOtpToast('aadhaar', aadhaarOtp); }
  startTimer(aadhaarTimer, aadhaarSendOtp);
});
 
aadhaarVerifyOtp.addEventListener('click', ()=>{
  if(!aadhaarOtp){ alert('Please click Send OTP first.'); return; }
  const code = aadhaarOtpUI.readValue();
  if(code === aadhaarOtp){
    aadhaarOtpVerifiedField.value = '1';
    aadharStatus.innerHTML = '<span class="text-success"><i class="bi bi-shield-check"></i> Aadhaar OTP verified</span>';
    aadhaarVerifyOtp.disabled = true; aadhaarOtpUI.disable();
  } else {
    aadharStatus.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> Incorrect OTP</span>';
  }
});
 
/* ====== PAN events ====== */
panNumber.addEventListener('input', ()=>{
  panNumber.value = panNumber.value.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,10);
  const ok = isValidPAN(panNumber.value);
  panStatus.innerHTML = ok ? '<span class="text-success"><i class="bi bi-check-circle"></i> Looks valid</span>'
                           : '<span class="text-danger">Format ABCDE1234F</span>';
  if(!ok){
    panOtpUI.disable(); panOtpUI.clearAll();
    panVerifyOtp.disabled = true; panOtpHint.textContent='';
    panOtpVerifiedField.value = '0';
  }
});
 
panSendOtp.addEventListener('click', ()=>{
  if(!isValidPAN(panNumber.value)){ panStatus.innerHTML='<span class="text-danger">Enter valid PAN</span>'; return; }
  panOtp = genOtp();
  panOtpUI.enable();
  panVerifyOtp.disabled = false;
  panStatus.innerHTML = '<span class="text-primary"><i class="bi bi-send"></i> OTP sent</span>';
  if(SHOW_TEST_OTP){ panOtpHint.textContent = 'On-screen OTP shown above'; showOtpToast('pan', panOtp); }
  startTimer(panTimer, panSendOtp);
});
 
panVerifyOtp.addEventListener('click', ()=>{
  if(!panOtp){ alert('Please click Send OTP first.'); return; }
  const code = panOtpUI.readValue();
  if(code === panOtp){
    panOtpVerifiedField.value = '1';
    panStatus.innerHTML = '<span class="text-success"><i class="bi bi-shield-check"></i> PAN OTP verified</span>';
    panVerifyOtp.disabled = true; panOtpUI.disable();
  } else {
    panStatus.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> Incorrect OTP</span>';
  }
});
 
/* ====== Submit Guard ====== */
const formEl = document.getElementById('ekycForm');
formEl.addEventListener('submit', (e)=>{
  // Photo required
  if(!passportPhotoInput.files || passportPhotoInput.files.length === 0){
    e.preventDefault(); alert('Please upload or capture your passport photo.'); return false;
  }
 
  // Mobile required (no format validation)
  if(!mobileNumber.value.trim()){
    e.preventDefault(); alert('Please enter your mobile number.'); return false;
  }
 
  // Aadhaar
  if(!isValidAadhaar(aadharNumber.value)){ e.preventDefault(); alert('Enter a valid 12-digit Aadhaar.'); return false; }
  if(document.getElementById('aadhaarOtpVerified').value !== '1'){ e.preventDefault(); alert('Please verify Aadhaar OTP.'); return false; }
 
  // PAN
  if(!isValidPAN(panNumber.value)){ e.preventDefault(); alert('Enter a valid PAN (ABCDE1234F).'); return false; }
  if(document.getElementById('panOtpVerified').value !== '1'){ e.preventDefault(); alert('Please verify PAN OTP.'); return false; }
 
  return true;
});
</script>
<style>
        body { font-family: Arial; margin: 0; background: #fff; }

        #chatButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #0066ff;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            color: white;
            font-size: 28px;
            border: none;
            cursor: pointer;
            box-shadow: 0px 4px 10px rgba(0,0,0,0.2);
        }

        #chatBox {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 360px;
            height: 480px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0px 4px 12px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
        }

        .chat-header {
            background: #0066ff;
            color: white;
            padding: 12px;
            font-size: 18px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
        }

        .chat-body {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }

        .msg {
            padding: 10px;
            margin: 8px 0;
            max-width: 80%;
            border-radius: 8px;
            font-size: 14px;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .user { background: #e3f0ff; margin-left: auto; }
        .bot { background: #f1f1f1; margin-right: auto; }

        .chat-inputBox {
            padding: 8px;
            display: flex;
            border-top: 1px solid #ccc;
        }

        textarea {
            flex: 1;
            resize: none;
            padding: 8px;
        }

        .sendBtn {
            width: 60px;
            background: #0066ff;
            color: white;
            border: none;
            border-radius: 6px;
            margin-left: 5px;
            cursor: pointer;
        }
    </style>

    <script>

        /* ‚ñ∂ FIXED: NEW CLEAN CHAT ON EVERY OPEN */
        function toggleChat() {

            // Remove old chat history
            localStorage.removeItem("chatHistory");

            // Clear UI messages
            document.getElementById("chatMessages").innerHTML = "";

            // Show chatbox
            document.getElementById("chatBox").style.display = "flex";
        }

        function loadHistory() {
            let history = JSON.parse(localStorage.getItem("chatHistory") || "[]");
            let box = document.getElementById("chatMessages");
            box.innerHTML = "";

            history.forEach(m => {
                box.innerHTML += `<div class='msg ${m.role}'>${m.text}</div>`;
            });

            box.scrollTop = box.scrollHeight;
        }

        function saveMessage(role, text) {
            let history = JSON.parse(localStorage.getItem("chatHistory") || "[]");
            history.push({ role, text });
            localStorage.setItem("chatHistory", JSON.stringify(history));
        }

        function sendMessage() {

            let input = document.getElementById("userMessage");
            let msg = input.value.trim();
            if (!msg) return;

            saveMessage("user", msg);
            loadHistory();

            input.value = "";

            fetch("/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: msg })
            })
            .then(res => res.json())
            .then(data => {
                saveMessage("bot", data.answer);
                loadHistory();
            });
        }
    </script>
</head>

<body>

<button id="chatButton" onclick="toggleChat()">üí¨</button>

<div id="chatBox">
    <div class="chat-header">
        DigiBank Chatbot
        <span onclick="document.getElementById('chatBox').style.display='none'" style="cursor:pointer;">‚ùå</span>
    </div>

    <div class="chat-body" id="chatMessages"></div>

    <div class="chat-inputBox">
        <textarea id="userMessage" placeholder="Type message..."></textarea>
        <button onclick="sendMessage()" class="sendBtn">Send</button>
    </div>
</div>
</body>
</html>
 
 