<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pay EMI — {{ loan.loan_account_no }}</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        :root {
            --brand: #0B4D83;
            --brand-alt: #97144D;
            --bg-page: #f1f5f9;
            --border-soft: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
        }

        body {
            background: radial-gradient(circle at top left, #e3f2fd 0, #f1f5f9 40%, #ffffff 100%);
            font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-main);
        }

        .page-shell {
            max-width: 980px;
            margin: 28px auto 40px;
        }

        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .top-row-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .top-header {
            background: linear-gradient(90deg, #0B4D83, #186cc4);
            border-radius: 16px;
            padding: 18px 22px;
            color: #f9fafb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.18);
            margin-bottom: 18px;
        }

        .top-header-left {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .top-icon-pill {
            width: 40px;
            height: 40px;
            border-radius: 999px;
            background: rgba(15,23,42,0.22);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .top-title-main {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
        }

        .top-subtitle {
            font-size: 13px;
            margin-top: 2px;
            opacity: 0.95;
        }

        .top-header-right {
            text-align: right;
            font-size: 13px;
        }

        .top-amount {
            font-size: 18px;
            font-weight: 700;
        }

        .chip-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            padding: 3px 10px;
            background: rgba(15,23,42,0.18);
            border: 1px solid rgba(255,255,255,0.35);
            font-size: 11px;
            font-weight: 600;
        }

        .card-block {
            background-color: #ffffff;
            border-radius: 14px;
            border: 1px solid var(--border-soft);
            padding: 18px 20px 20px;
            box-shadow: 0 2px 10px rgba(15, 23, 42, 0.06);
            margin-bottom: 18px;
        }

        .section-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .section-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .summary-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: .05em;
        }

        .summary-value {
            font-size: 15px;
            font-weight: 700;
            margin-top: 2px;
        }

        .summary-helper {
            font-size: 11px;
            color: var(--text-muted);
        }

        .pill-soft {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .emi-highlight {
            font-size: 20px;
            font-weight: 800;
            color: #0B4D83;
        }

        .divider-label {
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: .18em;
            color: var(--text-muted);
        }

        .balance-ok {
            border-left: 4px solid #22c55e;
        }

        .balance-low {
            border-left: 4px solid #f97316;
        }

        @media (max-width: 768px) {
            .top-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .top-header-right {
                text-align: left;
            }
        }
    </style>
</head>
<body>

<div class="page-shell">

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              <strong>{{ message }}</strong>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Top row -->
    <div class="top-row">
        <div class="top-row-title">
            DigiBank • Pay EMI
        </div>
        <div>
            <a href="{{ url_for('loan_emi_schedule', loan_account_id=loan.id) }}"
               class="btn btn-sm btn-outline-primary me-1">
                <i class="bi bi-arrow-left"></i> Back to EMI Schedule
            </a>
            <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </div>
    </div>

    <!-- Hero header -->
    <div class="top-header">
        <div class="top-header-left">
            <div class="top-icon-pill">
                <i class="bi bi-credit-card-2-front"></i>
            </div>
            <div>
                <p class="top-title-main mb-0">Loan A/c: {{ loan.loan_account_no }}</p>
                <p class="top-subtitle mb-0">
                    {{ loan.loan_type|title }} Loan • Application No: {{ loan.application_number }}
                </p>
                <div class="mt-1">
                    <span class="chip-badge">
                        <i class="bi bi-calendar-week"></i>
                        EMI #{{ emi.instalment_no }} &nbsp;•&nbsp; Due {{ emi.due_date }}
                    </span>
                </div>
            </div>
        </div>
        <div class="top-header-right">
            <div class="top-amount">
                ₹{{ "{:,.0f}".format(emi_amount|float) }}
            </div>
            <div style="font-size:12px;">
                This instalment amount
            </div>
            <div class="mt-1" style="font-size:12px; opacity:0.9;">
                Outstanding: <strong>₹{{ "{:,.0f}".format(loan.outstanding_principal|float) }}</strong>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <div class="row g-3">
        <!-- Left: Loan & EMI breakdown -->
        <div class="col-lg-6">
            <div class="card-block h-100">
                <div class="section-title mb-1">EMI Breakdown</div>
                <div class="section-subtitle">
                    Review this month’s EMI structure before confirming payment.
                </div>

                <div class="row mb-3">
                    <div class="col-6 mb-2">
                        <div class="summary-label">Instalment No</div>
                        <div class="summary-value">
                            #{{ emi.instalment_no }}
                        </div>
                        <div class="summary-helper">
                            Scheduled in your EMI plan
                        </div>
                    </div>
                    <div class="col-6 mb-2">
                        <div class="summary-label">Due Date</div>
                        <div class="summary-value">
                            {{ emi.due_date }}
                        </div>
                        <div class="summary-helper">
                            Please pay on or before this date
                        </div>
                    </div>
                </div>

                <div class="border rounded-3 p-3 mb-3" style="background:#f8fafc;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="summary-label">EMI Amount</span>
                        <span class="emi-highlight">
                            ₹{{ "{:,.0f}".format(emi_amount|float) }}
                        </span>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-2">
                            <span class="summary-label">Principal Component</span>
                            <div class="summary-value">
                                ₹{{ "{:,.0f}".format(emi.principal_component|float) }}
                            </div>
                        </div>
                        <div class="col-6 mb-2">
                            <span class="summary-label">Interest Component</span>
                            <div class="summary-value">
                                ₹{{ "{:,.0f}".format(emi.interest_component|float) }}
                            </div>
                        </div>
                    </div>
                    <div class="summary-helper mt-1">
                        Principal reduces your outstanding; interest is the cost of the loan.
                    </div>
                </div>

                <div class="row gy-2">
                    <div class="col-6">
                        
                    </div>
                    <div class="col-6">
                        
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Debit account & confirmation -->
        <div class="col-lg-6">
            <div class="card-block h-100">
                <div class="section-title mb-1">Payment Source</div>
                <div class="section-subtitle">
                    EMI will be debited from the linked DigiBank account.
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="summary-label">Debit From</div>
                            <div class="summary-value">
                                {{ debit_acct.account_type|capitalize if debit_acct.account_type else "Account" }}
                                • ****{{ debit_acct.account_number[-4:] }}
                            </div>
                            <div class="summary-helper">
                                Account No: {{ debit_acct.account_number }}
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="summary-label">Available Balance</div>
                            <div class="summary-value">
                                ₹{{ "{:,.2f}".format(debit_acct.balance|float) }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-3 border rounded-3 p-3 {% if remaining_balance >= 0 %}balance-ok{% else %}balance-low{% endif %}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="summary-label">Estimated Balance After Payment</div>
                            <div class="summary-value">
                                ₹{{ "{:,.2f}".format(remaining_balance|float) }}
                            </div>
                        </div>
                        <div class="text-end">
                            {% if remaining_balance >= 0 %}
                                <span class="pill-soft text-success">
                                    <i class="bi bi-check-circle"></i> Sufficient Balance
                                </span>
                            {% else %}
                                <span class="pill-soft text-danger">
                                    <i class="bi bi-exclamation-triangle"></i> Insufficient Balance
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="summary-helper mt-1">
                        We do not allow the account to go into negative balance.
                    </div>
                </div>

                <div class="text-center mb-3">
                    <div class="divider-label mb-1">Confirm Payment</div>
                    <small class="text-muted">
                        By continuing, you authorise DigiBank to debit the EMI amount from your above account
                        and apply it towards this loan instalment.
                    </small>
                </div>

                <form method="POST"
                      action="{{ url_for('pay_emi', loan_account_id=loan.id, instalment_no=emi.instalment_no) }}">
                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center gap-2">
                        <button type="submit"
                                class="btn btn-primary px-4"
                                {% if remaining_balance < 0 %}disabled{% endif %}>
                            <i class="bi bi-shield-check"></i>
                            Confirm &amp; Pay EMI
                        </button>

                        {% if remaining_balance < 0 %}
                            <span class="text-danger small">
                                Not enough balance to complete this payment.
                            </span>
                        {% else %}
                            
                        {% endif %}
                    </div>
                </form>

            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
