<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Loans - DigiBank Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
 
    <!-- Bootstrap CSS & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
 
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
 
    <style>
        /* ✅ keep your original CSS unchanged */
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #sidebarMenu.offcanvas-start { width: 250px; }
        #sidebarMenu .offcanvas-body { padding: 0.5rem 1rem; }
        #sidebarMenu .nav-link { font-size: 0.9rem; padding: 8px 12px; display: flex; align-items: center; gap: 8px; color: #333; transition: color 0.3s; }
        #sidebarMenu .nav-link.active { font-weight: 700; color: #97144D !important; background-color: #f0d7e0; border-radius: 4px; }
        #sidebarMenu .nav-link:hover { color: #7a0f3e; background-color: #f9e5ef; border-radius: 4px; }
        .top-bar { background-color: #97144D; color: white; display: flex; align-items: center; justify-content: space-between; padding: 10px 20px; user-select: none; position: sticky; top: 0; z-index: 1030; }
        .top-bar h5 { margin: 0; font-weight: 700; flex-grow: 1; text-align: center; color: white; }
        .logout-btn { background: transparent; border: 1.5px solid white; color: white; padding: 5px 15px; border-radius: 4px; font-weight: 600; cursor: pointer; }
        .logout-btn:hover { background-color: white; color: #97144D; }
        .main-content { margin-left: 250px; padding: 20px; }
        .card { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .card-header { background-color: #97144D; color: white; border-radius: 10px 10px 0 0 !important; }
        .btn-primary { background-color: #97144D; border-color: #97144D; }
        .table th { background-color: #f1f1f1; }
        .badge-pending { background-color: #ffc107; color: #212529; }
        .badge-approved { background-color: #28a745; color: white; }
        .badge-rejected { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
 
    <!-- ✅ Sidebar and top-bar remain unchanged -->
 
    <!-- Main Content -->
    <div class="main-content">
        <h2 class="mb-4"><i class="bi bi-file-earmark-check"></i> Manage Loans</h2>
 
        <!-- Loan Requests Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Loan Applications</h5>
            </div>
            <div class="card-body">
                <p>Approve or reject loan applications and modifications submitted by customers or branch staff.</p>
 
                <!-- Filters -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label for="loanTypeFilter" class="form-label">Loan Type</label>
                        <select class="form-select" id="loanTypeFilter" onchange="filterLoans()">
                            <option value="all">All Types</option>
                            <option value="Home Loan">Home Loan</option>
                            <option value="Personal Loan">Personal Loan</option>
                            <option value="Business Loan">Business Loan</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="loanStatusFilter" class="form-label">Status</label>
                        <select class="form-select" id="loanStatusFilter" onchange="filterLoans()">
                            <option value="all">All Statuses</option>
                            <option value="pending_manager">Pending</option>
                            <option value="Approved">Approved</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                </div>
 
                <!-- Loan Applications Table -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Loan ID</th>
                                <th>Customer</th>
                                <th>Loan Type</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="loanTableBody">
                            {% for loan in loans %}
                            <tr id="loanRow-{{ loan.request_id }}"
                                data-applicant="{{ loan.applicant_name }}"
                                data-type="{{ loan.loan_type|capitalize }} Loan"
                                data-amount="{{ loan.loan_amount }}"
                                data-date="{{ loan.application_date }}"
                                data-status="{{ loan.status }}"
                                data-purpose="{{ loan.purpose }}"
                                data-emi="{{ loan.emi_amount }}">
                                <td>{{ loan.request_id }}</td>
                                <td>{{ loan.applicant_name }}</td>
                                <td>{{ loan.loan_type|capitalize }} Loan</td>
                                <td>{{ loan.loan_amount }}</td>
                                <td>{{ loan.application_date }}</td>
                                <td>
                                    <span class="badge
                                        {% if loan.status == 'pending_manager' %}badge-pending
                                        {% elif loan.status == 'Approved' %}badge-approved
                                        {% elif loan.status == 'Rejected' %}badge-rejected
                                        {% endif %}">
                                        {{ loan.status }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary me-1" onclick="viewLoanDetails('{{ loan.request_id }}')">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    {% if loan.status == 'pending_manager' %}
                                    <form method="POST" action="{{ url_for('approve_loan', request_id=loan.request_id) }}" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-success me-1">
                                            <i class="bi bi-check-circle"></i> Approve
                                        </button>
                                    </form>
                                    <form method="POST" action="{{ url_for('reject_loan', request_id=loan.request_id) }}" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-danger">
                                            <i class="bi bi-x-circle"></i> Reject
                                        </button>
                                    </form>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="7" class="text-center">No loan applications found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
 
        <!-- Active Loans Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Active Loans</h5>
            </div>
            <div class="card-body">
                <p>View and manage currently active loans.</p>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Loan ID</th>
                                <th>Customer</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Disbursed</th>
                                <th>EMI</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="activeLoansTableBody">
                            {% for loan in loans if loan.status == 'Approved' %}
                            <tr>
                                <td>{{ loan.request_id }}</td>
                                <td>{{ loan.applicant_name }}</td>
                                <td>{{ loan.loan_type|capitalize }} Loan</td>
                                <td>{{ loan.loan_amount }}</td>
                                <td>{{ loan.updated_at.strftime('%Y-%m-%d') if loan.updated_at else '' }}</td>
                                <td>{{ loan.emi_amount }}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="viewLoanDetails('{{ loan.request_id }}')">
                                        <i class="bi bi-eye"></i> Details
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="7" class="text-center">No active loans yet.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
 
    <!-- Loan Details Modal -->
    <div class="modal fade" id="loanDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loanModalTitle">Loan Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="loanModalBody"></div>
            </div>
        </div>
    </div>
 
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
 
    <script>
      function viewLoanDetails(requestId) {
        const row = document.getElementById(`loanRow-${requestId}`);
        if (!row) return;
 
        const applicant = row.getAttribute("data-applicant");
        const type = row.getAttribute("data-type");
        const amount = row.getAttribute("data-amount");
        const date = row.getAttribute("data-date");
        const status = row.getAttribute("data-status");
        const purpose = row.getAttribute("data-purpose");
        const emi = row.getAttribute("data-emi");
 
        document.getElementById("loanModalTitle").textContent = `Loan Request - ${requestId}`;
        document.getElementById("loanModalBody").innerHTML = `
          <p><strong>Applicant:</strong> ${applicant}</p>
          <p><strong>Loan Type:</strong> ${type}</p>
          <p><strong>Amount:</strong> ${amount}</p>
          <p><strong>Application Date:</strong> ${date}</p>
          <p><strong>Status:</strong> ${status}</p>
          <p><strong>Purpose:</strong> ${purpose}</p>
          <p><strong>EMI:</strong> ${emi}</p>
        `;
        const modal = new bootstrap.Modal(document.getElementById('loanDetailsModal'));
        modal.show();
      }
 
      function filterLoans() {
        const typeFilter = document.getElementById('loanTypeFilter').value;
        const statusFilter = document.getElementById('loanStatusFilter').value;
 
        document.querySelectorAll('#loanTableBody tr').forEach(row => {
          const rowType = row.getAttribute('data-type');
          const rowStatus = row.getAttribute('data-status');
          let show = true;
 
          if (typeFilter !== 'all' && rowType !== typeFilter) show = false;
          if (statusFilter !== 'all' && rowStatus !== statusFilter) show = false;
 
          row.style.display = show ? '' : 'none';
        });
      }
    </script>
</body>
</html>
 
 