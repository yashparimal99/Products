<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Branch Performance - DigiBank</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- Charts + XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root { --brand:#97144D; }
    body{ background:#f8f9fa; font-family:'Segoe UI',sans-serif; min-height:100vh; display:flex; flex-direction:column; }
    .top-bar{ background:var(--brand); color:#fff; padding:10px 20px; position:sticky; top:0; z-index:1030;}
    .logout-btn{ background:transparent; border:1.5px solid #fff; color:#fff; padding:5px 15px; border-radius:4px; font-weight:600; text-decoration:none;}
    .logout-btn:hover{ background:#fff; color:var(--brand);}
    #sidebarMenu.offcanvas-start { width: 250px; }
    .performance-card{ transition:.3s; border-radius:10px; box-shadow:0 2px 8px rgb(0 0 0 / 10%); margin-bottom:20px; background:#fff;}
    .performance-card:hover{ transform:translateY(-3px); box-shadow:0 8px 20px rgb(0 0 0 / 12%); }
    .performance-card-header{ background:var(--brand); color:#fff; border-radius:10px 10px 0 0 !important; padding:14px 18px; }
    .kpi-card{ border-radius:10px; padding:16px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,.08); margin-bottom:15px; height:100%;}
    .kpi-label{ color:#6c757d; font-weight:600; font-size:.92rem; }
    .kpi-value{ font-size:1.75rem; font-weight:800; color:var(--brand); line-height:1.2; }
    .chart-container{ height:280px; position:relative; }
    .chart-container.tall{ height:360px; }
    .btn-period{ border:1px solid #dee2e6; }
    .btn-period.active{ background:var(--brand); color:#fff; border-color:var(--brand); }
    footer.bg-custom{ background:var(--brand); color:#fff; text-align:center; padding:14px 0; margin-top:auto; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="sidebarMenuLabel">Manager</h5>
      <button class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="nav flex-column">
        <li class="nav-item mb-2">
          <a class="nav-link text-dark active" href="{{ url_for('branchperformance') }}">
            <i class="bi bi-building me-2"></i> Branch Performance
          </a>
        </li>
      </ul>
    </div>
  </div>
 
  <!-- Top Bar -->
  <div class="top-bar d-flex align-items-center">
    <button class="btn btn-outline-light btn-sm me-3" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu">
      <i class="bi bi-list"></i>
    </button>
    <h5 class="me-auto mb-0">DigiBank Manager Dashboard</h5>
    <a class="logout-btn ms-3" href="{{ url_for('logout') }}">Logout</a>
  </div>
 
  <!-- Controls Row -->
  <div class="container mt-3">
    <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
      <div id="periodSelector" class="btn-group">
        <button class="btn btn-sm btn-outline-primary btn-period" data-period="day">Day</button>
        <button class="btn btn-sm btn-outline-primary btn-period" data-period="week">Week</button>
        <button class="btn btn-sm btn-outline-primary btn-period active" data-period="month">Month</button>
        <button class="btn btn-sm btn-outline-primary btn-period" data-period="quarter">Quarter</button>
        <button class="btn btn-sm btn-outline-primary btn-period" data-period="year">Year</button>
      </div>
 
      <select id="citySelect" class="form-select form-select-sm" style="max-width:260px">
        <option value="">All Cities</option>
      </select>
 
      <button id="exportPerformanceBtn" class="btn btn-sm btn-primary ms-auto">
        <i class="bi bi-download me-1"></i> Export
      </button>
    </div>
  </div>
 
  <!-- Search (reserved) -->
  <div class="container">
    <div class="input-group mb-3">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input id="performanceSearchInput" type="text" class="form-control" placeholder="Search branches / metrics..." />
    </div>
  </div>
 
  <!-- Main Content -->
  <div class="container my-2 flex-grow-1">
    <!-- KPI Rows -->
    <div class="row g-3 mb-2">
      <div class="col-6 col-md-4">
        <div class="kpi-card">
          <div class="kpi-label">New Customers</div>
          <div class="kpi-value" data-kpi="new-customers">--</div>
          <div class="small" data-kpi-delta="new-customers">+0</div>
        </div>
      </div>
      <div class="col-6 col-md-4">
        <div class="kpi-card">
          <div class="kpi-label">Total Deposits</div>
          <div class="kpi-value" data-kpi="total-deposits">--</div>
          <div class="small" data-kpi-delta="total-deposits">+₹0</div>
        </div>
      </div>
      <div class="col-6 col-md-4">
        <div class="kpi-card">
          <div class="kpi-label">Transactions</div>
          <div class="kpi-value" data-kpi="transactions">--</div>
          <div class="small" data-kpi-delta="transactions">+0</div>
        </div>
      </div>
    </div>
 
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3">
        <div class="kpi-card">
          <div class="kpi-label">Active Accounts</div>
          <div class="kpi-value" data-kpi="active-accounts">--</div>
          <div class="text-muted small">Approved only</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="kpi-card">
          <div class="kpi-label">Avg. Balance</div>
          <div class="kpi-value" data-kpi="avg-balance">--</div>
          <div class="text-muted small">CASA only</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="kpi-card">
          <div class="kpi-label">Txn / Employee</div>
          <div class="kpi-value" data-kpi="txn-per-emp">--</div>
          <div class="text-muted small">Efficiency</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="kpi-card">
          <div class="kpi-label">Total Customers</div>
          <div class="kpi-value" data-kpi="total-customers">--</div>
          <div class="text-muted small">All time</div>
        </div>
      </div>
    </div>
 
    <!-- Customer growth & Txns -->
    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <div class="performance-card h-100">
          <div class="performance-card-header">
            <h5 class="mb-0"><i class="bi bi-people me-2"></i> Customer Growth</h5>
          </div>
          <div class="card-body">
            <div class="chart-container"><canvas id="customerGrowthChart"></canvas></div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="performance-card h-100">
          <div class="performance-card-header">
            <h5 class="mb-0"><i class="bi bi-clipboard-data me-2"></i> Transactions Trend</h5>
          </div>
          <div class="card-body">
            <div class="chart-container"><canvas id="transactionsTrendChart"></canvas></div>
          </div>
        </div>
      </div>
    </div>
 
    <!-- Aggregated Counts (5 columns) -->
    <div class="performance-card mb-4">
      <div class="performance-card-header">
        <h5 class="mb-0"><i class="bi bi-bar-chart-line me-2"></i> Product Categories — Counts</h5>
      </div>
      <div class="card-body">
        <div class="chart-container tall"><canvas id="allTypesBar"></canvas></div>
        <small class="text-muted">Totals per category for the selected city (counts are independent of period).</small>
      </div>
    </div>
 
    <!-- Product Portfolio (Counts) -->
    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="performance-card h-100">
          <div class="performance-card-header">
            <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i> Accounts Mix (CASA) — Count</h6>
          </div>
          <div class="card-body"><div class="chart-container"><canvas id="pieAccounts"></canvas></div></div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="performance-card h-100">
          <div class="performance-card-header">
            <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i> Loans Mix — Count</h6>
          </div>
          <div class="card-body"><div class="chart-container"><canvas id="pieLoans"></canvas></div></div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="performance-card h-100">
          <div class="performance-card-header">
            <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i> Deposits Mix — Count</h6>
          </div>
          <div class="card-body"><div class="chart-container"><canvas id="pieDeposits"></canvas></div></div>
        </div>
      </div>
    </div>
 
    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <div class="performance-card h-100">
          <div class="performance-card-header">
            <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i> Cards Mix — Count</h6>
          </div>
          <div class="card-body"><div class="chart-container"><canvas id="pieCards"></canvas></div></div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="performance-card h-100">
          <div class="performance-card-header">
            <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i> Investments Mix — Count</h6>
          </div>
          <div class="card-body"><div class="chart-container"><canvas id="pieInvestments"></canvas></div></div>
        </div>
      </div>
    </div>
 
  </div>
 
  <footer class="bg-custom text-white text-center py-3 mt-auto">
    © 2025 DigiBank. Manager Dashboard. All rights reserved.
  </footer>
 
  <div class="toast-container position-fixed top-0 end-0 p-3"></div>
 
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const charts = {};
    const rup = n => '₹' + Number(n || 0).toLocaleString('en-IN');
    const fmt = n => Number(n || 0).toLocaleString('en-IN');
 
    function showToast(message, type = 'info') {
      const container = document.querySelector('.toast-container');
      const id = 't-' + Date.now();
      const toast = document.createElement('div');
      toast.className = `toast text-bg-${type==='success'?'success':type==='warning'?'warning':type==='danger'?'danger':'info'} border-0`;
      toast.setAttribute('role','alert');
      toast.setAttribute('aria-live','assertive');
      toast.setAttribute('aria-atomic','true');
      toast.id = id;
      toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      container.appendChild(toast);
      const bsToast = new bootstrap.Toast(toast, { autohide:true, delay:2500 });
      bsToast.show();
      toast.addEventListener('hidden.bs.toast', () => toast.remove());
    }
 
    document.addEventListener('DOMContentLoaded', async () => {
      document.querySelectorAll('#periodSelector .btn-period').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#periodSelector .btn-period').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          refreshAll();
        });
      });
      document.getElementById('citySelect')?.addEventListener('change', refreshAll);
      document.getElementById('performanceSearchInput').addEventListener('keyup', () => {}); // reserved
      document.getElementById('exportPerformanceBtn').addEventListener('click', exportPerformance);
 
      await loadCities();
      initAllCharts();
      await refreshAll();
    });
 
    async function loadCities() {
      try {
        const res = await fetch('/api/perf/cities');
        const cities = await res.json();
        const sel = document.getElementById('citySelect');
        (cities || []).forEach(c => {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          sel.appendChild(opt);
        });
      } catch(e){}
    }
 
    function activePeriod(){ return document.querySelector('#periodSelector .btn-period.active')?.dataset.period || 'month'; }
    function activeCity(){ return document.getElementById('citySelect')?.value || ''; }
 
    function initAllCharts() {
      charts.cust = new Chart(document.getElementById('customerGrowthChart'), {
        type:'line',
        data:{ labels:[], datasets:[{ label:'New Customers', data:[], tension:.3, fill:true }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
      });
 
      charts.txn = new Chart(document.getElementById('transactionsTrendChart'), {
        type:'bar',
        data:{ labels:[], datasets:[{ label:'Transactions', data:[] }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
      });
 
      // Aggregated counts: 5 columns
      charts.allTypes = new Chart(document.getElementById('allTypesBar'), {
        type:'bar',
        data:{
          labels:['Open Accounts','Deposits','Loans','Cards','Investments'],
          datasets:[{ label:'Count', data:[0,0,0,0,0] }]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:false} },
          scales:{ y:{ beginAtZero:true } }
        }
      });
 
      // Portfolio pies — all COUNTS
      charts.pieAccounts = new Chart(document.getElementById('pieAccounts'), {
        type:'doughnut',
        data:{ labels:['Saving','Current','Salary','PMJDY','Pension','Safe Custody'],
          datasets:[{ data:[0,0,0,0,0,0] }] },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{ position:'bottom' },
            tooltip:{ callbacks:{ label:ctx => `${ctx.label}: ${fmt(ctx.raw)} accounts` } }
          }
        }
      });
 
      charts.pieLoans = new Chart(document.getElementById('pieLoans'), {
        type:'doughnut',
        data:{ labels:['Home','Personal','Business'], datasets:[{ data:[0,0,0] }] },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{ position:'bottom' },
            tooltip:{ callbacks:{ label:ctx => `${ctx.label}: ${fmt(ctx.raw)} loans` } }
          }
        }
      });
 
      charts.pieDeposits = new Chart(document.getElementById('pieDeposits'), {
        type:'doughnut',
        data:{ labels:['FD','Digital FD','RD'], datasets:[{ data:[0,0,0] }] },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{ position:'bottom' },
            tooltip:{ callbacks:{ label:ctx => `${ctx.label}: ${fmt(ctx.raw)} deposits` } }
          }
        }
      });
 
      charts.pieCards = new Chart(document.getElementById('pieCards'), {
        type:'doughnut',
        data:{ labels:['Credit','Debit','Prepaid','Forex'], datasets:[{ data:[0,0,0,0] }] },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{ position:'bottom' },
            tooltip:{ callbacks:{ label:ctx => `${ctx.label}: ${fmt(ctx.raw)} cards` } }
          }
        }
      });
 
      charts.pieInvestments = new Chart(document.getElementById('pieInvestments'), {
        type:'doughnut',
        data:{ labels:['PPF','FRSB','NPS'], datasets:[{ data:[0,0,0] }] },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{ position:'bottom' },
            tooltip:{ callbacks:{ label:ctx => `${ctx.label}: ${fmt(ctx.raw)} accounts` } }
          }
        }
      });
    }
 
    async function refreshAll(){
      const period = activePeriod(), city = activeCity();
      await Promise.all([
        refreshKPIs(period, city),
        refreshTrends(city),
        refreshPies(city)   // also updates the aggregated 5-column bar
      ]);
      showToast(`Updated for ${city ? city + ' · ' : ''}${period}`,'success');
    }
 
    async function refreshKPIs(period, city){
      try{
        const k = await (await fetch(`/api/perf/kpis?period=${period}&city=${encodeURIComponent(city)}`)).json();
 
        setText('[data-kpi="new-customers"]', k.new_accounts ?? '--');
        setText('[data-kpi="total-deposits"]', rup(k.total_deposits));
        setText('[data-kpi="transactions"]', k.transactions ?? '--');
        setText('[data-kpi="active-accounts"]', k.active_accounts ?? '--');
        setText('[data-kpi="avg-balance"]', rup(k.avg_balance));
        setText('[data-kpi="txn-per-emp"]', k.txn_per_employee ?? '--');
        setText('[data-kpi="total-customers"]', k.total_customers ?? '--');
 
        setDeltaCount('new-customers', k.delta_new_count);
        setDeltaCount('total-deposits', k.delta_deposits_abs);
        setDeltaCount('transactions', k.delta_transactions_count);
      }catch(e){}
    }
 
    // Only Customer Growth & Transactions Trend
    async function refreshTrends(city){
      try{
        const t = await (await fetch(`/api/perf/trend?city=${encodeURIComponent(city)}`)).json();
        const labels = (t||[]).map(r => new Date(r.m).toLocaleDateString('en-IN',{month:'short', year:'2-digit'}));
 
        charts.cust.data.labels = labels;
        charts.cust.data.datasets[0].data = (t||[]).map(r=>r.new_accounts||0);
        charts.cust.update();
 
        charts.txn.data.labels = labels;
        charts.txn.data.datasets[0].data = (t||[]).map(r=>r.txns||0);
        charts.txn.update();
      }catch(e){}
    }
 
    // Populate pies + aggregated 5-column bar using /api/perf/pies counts
    async function refreshPies(city){
      try{
        const res = await fetch(`/api/perf/pies?city=${encodeURIComponent(city||'')}`);
        const d = await res.json();
 
        // ---- Pies (counts) ----
        const acc = d.accounts || {};
        charts.pieAccounts.data.datasets[0].data = [
          acc.saving||0, acc.current||0, acc.salary||0, acc.pmjdy||0, acc.pension||0, acc.safecustody||0
        ];
        charts.pieAccounts.update();
 
        const l = d.loans || {};
        charts.pieLoans.data.datasets[0].data = [l.home||0, l.personal||0, l.business||0];
        charts.pieLoans.update();
 
        const dp = d.deposits || {};
        charts.pieDeposits.data.datasets[0].data = [dp.fd||0, dp.digital_fd||0, dp.rd||0];
        charts.pieDeposits.update();
 
        const c = d.cards || {};
        charts.pieCards.data.datasets[0].data = [c.credit||0, c.debit||0, c.prepaid||0, c.forex||0];
        charts.pieCards.update();
 
        const inv = d.investments || {};
        charts.pieInvestments.data.datasets[0].data = [inv.PPF||0, inv.FRSB||0, inv.NPS||0];
        charts.pieInvestments.update();
 
        // ---- Aggregated totals for 5-column bar ----
        const sum = obj => Object.values(obj||{}).reduce((a,b)=>a + (Number(b)||0), 0);
        const totals = [
          sum(acc),  // Open Accounts total
          sum(dp),   // Deposits total
          sum(l),    // Loans total
          sum(c),    // Cards total
          sum(inv)   // Investments total
        ];
        charts.allTypes.data.datasets[0].data = totals;
        charts.allTypes.update();
 
      }catch(e){
        console.error(e);
        showToast('Failed to load portfolio data','danger');
      }
    }
 
    function setText(sel,val){ const el=document.querySelector(sel); if(el) el.textContent = val; }
 
    // absolute delta renderer
    function setDeltaCount(key, val){
      const el = document.querySelector(`[data-kpi-delta="${key}"]`);
      if(!el || val === undefined || val === null) return;
      const v = Number(val);
      el.classList.remove('text-success','text-danger','text-muted');
      el.classList.add(v >= 0 ? 'text-success' : 'text-danger');
 
      if (key === 'total-deposits') {
        el.textContent = `${v>=0?'+':'-'}${rup(Math.abs(v))}`;
      } else {
        el.textContent = `${v>=0?'+':'-'}${fmt(Math.abs(v))}`;
      }
    }
 
    function exportPerformance(){
      const period = activePeriod().toUpperCase(), city = activeCity() || 'ALL';
      const sheet = [
        ['Branch Performance Report','','',''],
        ['Period',period,'City',city],
        ['','','',''],
        ['Metric','Value','Notes',''],
        ['New Customers',document.querySelector('[data-kpi="new-customers"]').textContent,'',''],
        ['Total Deposits',document.querySelector('[data-kpi="total-deposits"]').textContent,'',''],
        ['Transactions',document.querySelector('[data-kpi="transactions"]').textContent,'',''],
        ['Active Accounts',document.querySelector('[data-kpi="active-accounts"]').textContent,'',''],
        ['Avg. Balance',document.querySelector('[data-kpi="avg-balance"]').textContent,'CASA only',''],
        ['Txn/Employee',document.querySelector('[data-kpi="txn-per-emp"]').textContent,'',''],
        ['Total Customers',document.querySelector('[data-kpi="total-customers"]').textContent,'','']
      ];
      const ws = XLSX.utils.aoa_to_sheet(sheet), wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Performance");
      const d=new Date(), ts=`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
      XLSX.writeFile(wb, `Branch_Performance_${city}_${period}_${ts}.xlsx`);
      showToast('Report exported','success');
    }
  </script>
</body>
</html>
 
 
 