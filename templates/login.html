<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DigiBank — Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
 
  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
 
  <style>
    :root{
      --brand:#0B4D83;      /* primary */
      --brand-2:#7a103c;    /* accent */
      --ink:#0f172a;
      --muted:#64748b;
      --bg1:#0b1625;
      --bg2:#102944;
 
      /* Forgot Password palette */
      --fp-head-from:#0B4D83;
      --fp-head-to:#186cc4;
      --fp-card:#ffffff;
      --fp-soft:#eef6ff;
      --fp-line:#e6eef8;
      --fp-ink:#0c2748;
      --fp-muted:#5a6f86;
 
      --ok:#16a34a;
      --warn:#eab308;
    }
 
    /* Page background */
    body{
      min-height:100vh; margin:0; color:#e6eef7;
      background: radial-gradient(900px 500px at 10% -10%, #205a9f33 0%, transparent 60%),
                  radial-gradient(700px 600px at 100% 0%, #7a103c22 0%, transparent 65%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
 
    /* Top bar */
    .navbar{
      background: linear-gradient(90deg, #0b4d83, #1771c8);
      border-bottom: 1px solid #ffffff22;
    }
    .brand-dot{
      width:32px; height:32px; border-radius:8px;
      background: conic-gradient(from 0deg, #667eea, #764ba2, #f093fb, #4facfe, #667eea);
      box-shadow: 0 6px 18px rgba(79,172,254,.25);
    }
 
    /* Login Card */
    .wrap{ display:grid; place-items:center; padding:96px 16px 40px; }
    .cardx{
      width:100%; max-width:560px; color:#0b2342; background:#ffffffee;
      border:1px solid #ffffff; border-radius:16px; padding:26px 24px;
      box-shadow: 0 18px 56px rgba(7,17,36,.35);
    }
    .title{ color:var(--brand); font-weight:800; letter-spacing:.2px; margin:0; }
    .muted{ color:#5c6f86; }
 
    /* Buttons */
    .btn-brand{ background:var(--brand); color:#fff; border:1px solid var(--brand); font-weight:700; }
    .btn-brand:hover{ background:var(--brand-2); border-color:var(--brand-2); }
    .btn-ghost{ border:1.4px solid var(--brand); color:var(--brand); font-weight:600; background:transparent; }
    .btn-ghost.active, .btn-ghost:hover{ background:var(--brand); color:#fff; }
 
    /* Section frame */
    .section{ border:1px dashed #0b4d8330; border-radius:12px; background:#f8fbff; padding:12px; }
 
    /* Pills */
    .pill-verified{
      display:inline-flex; align-items:center; gap:.4rem;
      background:#d1fae5; color:#065f46; border:1px solid #84e1bc;
      border-radius:999px; padding:.15rem .55rem; font-size:.78rem; font-weight:800;
    }
    .pill-sent{
      display:inline-flex; align-items:center; gap:.4rem;
      background:#eef6ff; color:#0b4d83; border:1px solid #cfe4ff;
      border-radius:999px; padding:.18rem .55rem; font-size:.78rem; font-weight:700;
    }
    .pill-otp{
      display:inline-flex; align-items:center; gap:.35rem;
      background:#fff6e5; color:#7a4b00; border:1px solid #f3d08a;
      border-radius:10px; padding:.18rem .5rem; font-size:.82rem; font-weight:800;
    }
 
    /* OTP UI (compact) */
    .otp-row-compact{ margin-top:.35rem; }
    .otp-boxes{ display:flex; gap:6px; }
    .otp-boxes input{
      width:36px; height:44px; text-align:center; font-weight:800; font-size:16px;
      border:1.25px solid #cfd8e3; border-radius:8px; outline:none; color:#0b2540; padding:0;
    }
    .otp-boxes input:focus{ border-color:var(--brand); box-shadow:0 0 0 3px #0b4d8330; }
 
    @media (max-width: 420px){
      .otp-boxes{ gap:5px; }
      .otp-boxes input{ width:32px; height:40px; font-size:15px; border-radius:7px; }
      .pill-otp, .pill-sent{ font-size:.76rem; }
    }
 
    .is-readonly{ pointer-events:none; opacity:.7; }
 
    /* =========================
       FORGOT PASSWORD — DESIGN
       ========================= */
    .fp-modal .modal-content{
      border: 1px solid var(--fp-line);
      border-radius: 16px;
      overflow: hidden;
      background: var(--fp-card);
    }
    .fp-modal .modal-header{
      background: linear-gradient(90deg, var(--fp-head-from), var(--fp-head-to));
      color:#fff; border-bottom:none; padding:14px 16px;
    }
    .fp-modal .modal-title{
      font-weight:800; letter-spacing:.2px;
    }
    .fp-modal .modal-body{
      background:
        radial-gradient(540px 220px at 100% -20%, #e9f2ff 0%, transparent 60%),
        linear-gradient(180deg, #ffffff, #f9fbff);
      padding: 18px 18px 2px;
    }
    .fp-card{
      border:1px solid var(--fp-line);
      background:#ffffffdd;
      border-radius:14px;
      padding:14px;
      color:var(--fp-ink);
    }
    .fp-muted{ color:var(--fp-muted); }
 
    .fp-label{ font-weight:700; color:var(--fp-ink); }
    .fp-input.form-control,
    .fp-input.form-select{
      border:1.25px solid #cfe0f2;
    }
    .fp-input:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 3px #0b4d8330;
    }
    .fp-divider{
      height:1px; background:linear-gradient(90deg, transparent, var(--fp-line), transparent);
      margin:10px 0 6px;
    }
    .fp-row{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
    }
    .fp-badges{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .fp-actions{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .fp-footer{
      padding: 10px 18px 16px;
      display:flex; justify-content:flex-end; gap:10px;
      background:#f8fbff; border-top:1px solid var(--fp-line);
    }
  </style>
</head>
<body>
 
  <!-- Topbar -->
  <nav class="navbar navbar-dark fixed-top">
    <div class="container-fluid d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <span class="brand-dot"></span>
        <strong>DiGi<span class="text-white-50">Bank</span></strong>
      </div>
      <a href="{{ url_for('signup') }}" class="btn btn-sm btn-outline-light">
        <i class="bi bi-person-plus me-1"></i> Sign Up
      </a>
    </div>
  </nav>
 
  <main class="wrap">
    <div class="cardx">
      <div class="text-center mb-2">
        <h3 class="title">Login</h3>
       
      </div>
 
      <!-- Flash -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
 
      <form id="loginForm" method="post" novalidate>
        <input type="hidden" name="otp_verified" id="login_otp_verified" value="0"/>
 
        <!-- Method toggle -->
        <div class="mb-3 d-flex align-items-center justify-content-between">
          <label class="form-label fw-bold m-0">Verification Method</label>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-ghost btn-sm active" id="chooseEmail">
              <i class="bi bi-envelope me-1"></i>Email
            </button>
            <button type="button" class="btn btn-ghost btn-sm" id="chooseMobile">
              <i class="bi bi-phone me-1"></i>Mobile
            </button>
          </div>
        </div>
 
        <!-- Identity -->
        <div class="section mb-3">
          <!-- Email -->
          <div id="emailBlock" class="mt-1">
            <label class="form-label fw-semibold" for="loginEmail">Registered Email</label>
            <div class="input-group">
              <input type="email" class="form-control" id="loginEmail" name="email" placeholder="you@example.com" autocomplete="email">
              <button class="btn btn-ghost" type="button" id="sendOtpEmail"><i class="bi bi-send"></i> Send OTP</button>
            </div>
            <div id="emailErr" class="text-danger small mt-1 d-none">Enter a valid email.</div>
          </div>
 
          <!-- Mobile -->
          <div id="mobileBlock" class="mt-1" style="display:none;">
            <label class="form-label fw-semibold" for="loginMobile">Registered Mobile</label>
            <div class="input-group">
              <span class="input-group-text">+91</span>
              <input type="text" class="form-control" id="loginMobile" name="mobile" inputmode="numeric" maxlength="10" placeholder="10-digit mobile">
              <button class="btn btn-ghost" type="button" id="sendOtpMobile"><i class="bi bi-send"></i> Send OTP</button>
            </div>
            <div id="mobileErr" class="text-danger small mt-1 d-none">Enter a valid 10-digit mobile.</div>
          </div>
 
          <!-- Sent info + OTP -->
          <div id="sentInfo" class="mt-2 d-none d-flex align-items-center gap-2 flex-wrap">
            <span class="pill-sent" id="sentTargetPill"><i class="bi bi-check2-circle"></i> Sent to: —</span>
            <span class="pill-otp" id="otpDisplayPill">
              <i class="bi bi-shield-lock"></i>
              OTP: <span id="otpValue">———</span>
              <button type="button" class="btn btn-sm btn-link p-0 ms-1" id="copyOtpBtn" title="Copy OTP">
                <i class="bi bi-clipboard"></i>
              </button>
            </span>
          </div>
 
          <!-- OTP input -->
          <div id="otpRow" class="otp-row-compact d-none">
            <div class="row g-2 align-items-center">
              <div class="col-12 col-md-auto">
                <div class="otp-boxes" id="otpBoxes">
                  <input type="text" maxlength="1" inputmode="numeric" autocomplete="one-time-code">
                  <input type="text" maxlength="1" inputmode="numeric" autocomplete="one-time-code">
                  <input type="text" maxlength="1" inputmode="numeric" autocomplete="one-time-code">
                  <input type="text" maxlength="1" inputmode="numeric" autocomplete="one-time-code">
                  <input type="text" maxlength="1" inputmode="numeric" autocomplete="one-time-code">
                  <input type="text" maxlength="1" inputmode="numeric" autocomplete="one-time-code">
                </div>
                <input type="text" id="otpHidden" class="d-none" />
              </div>
 
              <div class="col-12 col-md-auto d-flex gap-2">
                <button class="btn btn-success btn-sm" id="verifyOtpBtn" type="button">
                  <i class="bi bi-check2-circle me-1"></i> Verify
                </button>
              </div>
 
              <div class="col-12 col-md-auto">
                <button class="btn btn-outline-secondary btn-sm" id="resendBtn" type="button" disabled>Resend (30s)</button>
              </div>
 
              <div class="col-12 col-md-auto">
                <span id="verifiedPill" class="pill-verified d-none"><i class="bi bi-shield-check"></i> Verified</span>
              </div>
            </div>
 
            <div id="otpErr" class="text-danger small mt-2 d-none">Incorrect OTP.</div>
          </div>
        </div>
 
        <!-- Password -->
        <fieldset id="passwordFieldset" disabled>
          <div class="mb-3">
            <label class="form-label fw-semibold" for="password">Password</label>
            <input type="password" class="form-control" id="password" name="password" placeholder="Your password" required autocomplete="current-password">
            <div class="invalid-feedback">Password is required.</div>
          </div>
        </fieldset>
 
        <div class="d-flex align-items-center justify-content-between mb-3">
          <a class="text-decoration-none" style="color:var(--brand);" href="#" data-bs-toggle="modal" data-bs-target="#forgotModal">Forgot password?</a>
        </div>
 
        <button type="submit" id="loginBtn" class="btn btn-brand w-100" disabled>
          <span class="btn-text">Login</span>
          <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
        </button>
 
        <p class="muted text-center mt-3 mb-0">
          New here? <a href="{{ url_for('signup') }}" class="text-decoration-none" style="color:var(--brand);">Create account</a>
        </p>
      </form>
    </div>
  </main>
 
  <!-- =========================
       FORGOT PASSWORD (Re-styled)
       ========================= -->
  <div class="modal fade fp-modal" id="forgotModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
 
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-unlock me-2"></i> Reset Password
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
 
        <div class="modal-body">
          <div class="fp-card mb-2">
            <form method="post" action="{{ url_for('forgot_password_simple') }}" id="forgotForm" novalidate>
              <input type="hidden" name="otp_verified" id="fp_otp_verified" value="0"/>
 
              <!-- Email + Send -->
              <div class="mb-2">
                <label class="fp-label form-label" for="fpEmail">Registered Email</label>
                <div class="input-group">
                  <input type="email" class="form-control fp-input" id="fpEmail" name="email" placeholder="you@example.com" required>
                  <button class="btn btn-ghost" type="button" id="fpSendOtpBtn">
                    <i class="bi bi-send"></i> Send OTP
                  </button>
                </div>
              </div>
 
              <div class="fp-divider"></div>
 
              <!-- Sent target + OTP value -->
              <div class="fp-row mb-1">
                <div class="fp-badges d-none" id="fpSentInfo">
                  <span class="pill-sent" id="fpSentTargetPill"><i class="bi bi-check2-circle"></i> Sent to: —</span>
                  <span class="pill-otp" id="fpOtpDisplayPill">
                    <i class="bi bi-shield-lock"></i>
                    OTP: <span id="fpOtpValue">———</span>
                    <button type="button" class="btn btn-sm btn-link p-0 ms-1" id="fpCopyOtpBtn" title="Copy OTP">
                      <i class="bi bi-clipboard"></i>
                    </button>
                  </span>
                </div>
 
                <div class="fp-actions">
                  <button class="btn btn-outline-secondary btn-sm" id="fpResendBtn" type="button" disabled>Resend (30s)</button>
                </div>
              </div>
 
              <!-- OTP inputs -->
              <div id="fpOtpRow" class="otp-row-compact d-none">
                <div class="row g-2 align-items-center">
                  <div class="col-12 col-md-auto">
                    <div class="otp-boxes" id="fpOtpBoxes">
                      <input type="text" maxlength="1" inputmode="numeric" autocomplete="one-time-code">
                      <input type="text" maxlength="1" inputmode="numeric" autocomplete="one-time-code">
                      <input type="text" maxlength="1" inputmode="numeric" autocomplete="one-time-code">
                      <input type="text" maxlength="1" inputmode="numeric" autocomplete="one-time-code">
                      <input type="text" maxlength="1" inputmode="numeric" autocomplete="one-time-code">
                      <input type="text" maxlength="1" inputmode="numeric" autocomplete="one-time-code">
                    </div>
                    <input type="text" id="fpOtpHidden" class="d-none" />
                  </div>
 
                  <div class="col-12 col-md-auto d-flex gap-2">
                    <button class="btn btn-success btn-sm" id="fpOtpVerifyBtn" type="button">
                      <i class="bi bi-check2-circle me-1"></i> Verify
                    </button>
                    <span id="fpVerifiedPill" class="pill-verified d-none"><i class="bi bi-shield-check"></i> Verified</span>
                  </div>
                </div>
 
                <div id="fpOtpErr" class="text-danger small mt-2 d-none">Incorrect OTP.</div>
              </div>
 
              <div class="fp-divider"></div>
 
              <!-- New password (enabled after verify) -->
              <fieldset id="fpPassFieldset" disabled>
                <div class="row g-2">
                  <div class="col-12 col-md-6">
                    <label class="fp-label form-label" for="fpPass">New Password</label>
                    <input type="password" class="form-control fp-input" id="fpPass" name="password" minlength="8" placeholder="Min 8 characters" required>
                  </div>
                  <div class="col-12 col-md-6">
                    <label class="fp-label form-label" for="fpConf">Confirm Password</label>
                    <input type="password" class="form-control fp-input" id="fpConf" name="confirm_password" required>
                  </div>
                </div>
              </fieldset>
 
              <!-- Footer actions -->
              <div class="fp-footer">
                <button class="btn btn-outline-secondary" data-bs-dismiss="modal" type="button">Close</button>
                <button class="btn btn-brand" id="fpSubmit" type="submit" disabled>
                  <i class="bi bi-check-circle me-1"></i> Update Password
                </button>
              </div>
            </form>
          </div>
          <div class="text-center fp-muted small">Use your registered email to receive OTP.</div>
        </div>
 
      </div>
    </div>
  </div>
 
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const mobRe   = /^\d{10}$/;
 
    /* Utils */
    function startCountdown(btn, seconds=30){
      btn.disabled = true;
      btn.textContent = `Resend (${seconds}s)`;
      const t = setInterval(()=>{
        seconds--;
        btn.textContent = `Resend (${seconds}s)`;
        if(seconds<=0){ clearInterval(t); btn.disabled=false; btn.textContent='Resend'; }
      },1000);
    }
    function setBtnLoading(btn, on){
      const spinner = btn.querySelector('.spinner-border');
      const text    = btn.querySelector('.btn-text');
      if(spinner && text){
        if(on){ spinner.classList.remove('d-none'); text.textContent='Processing...'; btn.disabled=true; }
        else  { spinner.classList.add('d-none'); text.textContent='Login'; btn.disabled=false; }
      }
    }
    function boxesToValue(boxNodes){ return Array.from(boxNodes).map(el=>el.value.trim()).join(''); }
    function wireOtpBoxes(containerId, hiddenId){
      const boxes = document.querySelectorAll(`#${containerId} input`);
      const hidden = document.getElementById(hiddenId);
      boxes.forEach((el, idx)=>{
        el.addEventListener('input', e=>{
          e.target.value = e.target.value.replace(/\D/g,'').slice(0,1);
          if(e.target.value && idx < boxes.length-1){ boxes[idx+1].focus(); }
          hidden.value = boxesToValue(boxes);
        });
        el.addEventListener('keydown', e=>{
          if(e.key==='Backspace' && !e.target.value && idx>0){
            boxes[idx-1].focus(); boxes[idx-1].value=''; hidden.value = boxesToValue(boxes);
          }
        });
      });
      return {boxes, hidden};
    }
    function maskTarget(v){
      v = (v||'').trim();
      if(!v) return '';
      if(v.includes('@')){
        const [u,d]=v.split('@');
        const base = u.length<=2 ? (u[0]||'*')+'***' : u.slice(0,2)+'***';
        return `${base}@${d}`;
      }
      return v.replace(/^(\d{3})\d{4}(\d{3})$/, '$1****$2');
    }
 
    /* ===== Login flow ===== */
    const loginForm = document.getElementById('loginForm');
    const loginBtn  = document.getElementById('loginBtn');
    const passwordFieldset = document.getElementById('passwordFieldset');
    const pwdInput = document.getElementById('password');
    const otpVerifiedFlag = document.getElementById('login_otp_verified');
 
    const chooseEmail = document.getElementById('chooseEmail');
    const chooseMobile= document.getElementById('chooseMobile');
    const emailBlock  = document.getElementById('emailBlock');
    const mobileBlock = document.getElementById('mobileBlock');
 
    const loginEmail  = document.getElementById('loginEmail');
    const loginMobile = document.getElementById('loginMobile');
    const emailErr    = document.getElementById('emailErr');
    const mobileErr   = document.getElementById('mobileErr');
 
    const sendOtpEmail= document.getElementById('sendOtpEmail');
    const sendOtpMobile=document.getElementById('sendOtpMobile');
 
    const sentInfo    = document.getElementById('sentInfo');
    const sentTargetPill = document.getElementById('sentTargetPill');
    const otpValueSpan   = document.getElementById('otpValue');
    const copyOtpBtn  = document.getElementById('copyOtpBtn');
 
    const otpRow      = document.getElementById('otpRow');
    const {boxes: otpBoxes, hidden: otpHidden} = wireOtpBoxes('otpBoxes','otpHidden');
    const verifyOtpBtn= document.getElementById('verifyOtpBtn');
    const resendBtn   = document.getElementById('resendBtn');
    const verifiedPill= document.getElementById('verifiedPill');
    const otpErr      = document.getElementById('otpErr');
 
    let method = 'email';
    let currentOTP = null;
    let targetValue = '';
 
    function resetOtpUI(){
      sentInfo.classList.add('d-none');
      otpRow.classList.add('d-none');
      verifiedPill.classList.add('d-none');
      otpErr.classList.add('d-none');
      otpBoxes.forEach(x=>x.value=''); otpHidden.value='';
      resendBtn.disabled=true;
      otpVerifiedFlag.value='0';
      passwordFieldset.disabled=true;
      loginBtn.disabled=true;
    }
    function setMethod(m){
      method = m;
      chooseEmail.classList.toggle('active', m==='email');
      chooseMobile.classList.toggle('active', m==='mobile');
      emailBlock.style.display  = (m==='email') ? '' : 'none';
      mobileBlock.style.display = (m==='mobile')? '' : 'none';
      resetOtpUI();
    }
    chooseEmail.addEventListener('click', ()=> setMethod('email'));
    chooseMobile.addEventListener('click',()=> setMethod('mobile'));
    setMethod('email');
 
    // Send OTP (Email)
    sendOtpEmail.addEventListener('click', ()=>{
      const v = (loginEmail.value||'').trim();
      if(!emailRe.test(v)){ emailErr.classList.remove('d-none'); return; }
      emailErr.classList.add('d-none');
 
      targetValue = v;
      currentOTP = Math.floor(100000+Math.random()*900000);
      sentTargetPill.innerHTML = `<i class="bi bi-check2-circle"></i> Sent to: ${maskTarget(v)}`;
      otpValueSpan.textContent = String(currentOTP);
      sentInfo.classList.remove('d-none');
      otpRow.classList.remove('d-none');
      startCountdown(resendBtn, 30);
      otpBoxes[0].focus();
    });
 
    // Send OTP (Mobile)
    sendOtpMobile.addEventListener('click', ()=>{
      const v = (loginMobile.value||'').trim();
      if(!mobRe.test(v)){ mobileErr.classList.remove('d-none'); return; }
      mobileErr.classList.add('d-none');
 
      targetValue = v;
      currentOTP = Math.floor(100000+Math.random()*900000);
      sentTargetPill.innerHTML = `<i class="bi bi-check2-circle"></i> Sent to: +91 ${maskTarget(v)}`;
      otpValueSpan.textContent = String(currentOTP);
      sentInfo.classList.remove('d-none');
      otpRow.classList.remove('d-none');
      startCountdown(resendBtn, 30);
      otpBoxes[0].focus();
    });
 
    // Copy OTP (demo)
    copyOtpBtn.addEventListener('click', ()=>{
      if(!currentOTP) return;
      navigator.clipboard.writeText(String(currentOTP));
      copyOtpBtn.innerHTML = '<i class="bi bi-clipboard-check text-success"></i>';
      setTimeout(()=> copyOtpBtn.innerHTML = '<i class="bi bi-clipboard"></i>', 1200);
    });
 
    // Resend OTP
    resendBtn.addEventListener('click', ()=>{
      if(!targetValue) return;
      currentOTP = Math.floor(100000+Math.random()*900000);
      otpValueSpan.textContent = String(currentOTP);
      startCountdown(resendBtn, 30);
      otpBoxes.forEach(x=>x.value=''); otpHidden.value='';
      otpBoxes[0].focus();
    });
 
    // Verify OTP
    verifyOtpBtn.addEventListener('click', ()=>{
      if((otpHidden.value||'') === String(currentOTP)){
        otpErr.classList.add('d-none');
        verifiedPill.classList.remove('d-none');
        otpVerifiedFlag.value='1';
        passwordFieldset.disabled=false;
        loginBtn.disabled=false;
 
        // freeze
        sendOtpEmail.classList.add('is-readonly');
        sendOtpMobile.classList.add('is-readonly');
        chooseEmail.classList.add('is-readonly');
        chooseMobile.classList.add('is-readonly');
        loginEmail.readOnly = true;
        loginMobile.readOnly = true;
        resendBtn.disabled=true;
      }else{
        otpErr.classList.remove('d-none');
      }
    });
 
    // Submit
    loginForm.addEventListener('submit', (e)=>{
      const okPwd = (pwdInput.value||'').length>0;
      const verified = otpVerifiedFlag.value==='1';
      if(!verified || !okPwd){
        e.preventDefault(); e.stopPropagation();
        if(!okPwd) pwdInput.classList.add('is-invalid');
        return;
      }
      setBtnLoading(loginBtn, true);
    });
 
    /* ===== Forgot flow (styled) ===== */
    const forgotForm     = document.getElementById('forgotForm');
    const fpEmail        = document.getElementById('fpEmail');
    const fpSendOtpBtn   = document.getElementById('fpSendOtpBtn');
 
    const fpSentInfo     = document.getElementById('fpSentInfo');
    const fpSentTargetPill = document.getElementById('fpSentTargetPill');
    const fpOtpValue     = document.getElementById('fpOtpValue');
    const fpCopyOtpBtn   = document.getElementById('fpCopyOtpBtn');
 
    const fpOtpRow       = document.getElementById('fpOtpRow');
    const {boxes: fpOtpBoxes, hidden: fpOtpHidden} = wireOtpBoxes('fpOtpBoxes','fpOtpHidden');
    const fpOtpVerifyBtn = document.getElementById('fpOtpVerifyBtn');
    const fpResendBtn    = document.getElementById('fpResendBtn');
    const fpOtpErr       = document.getElementById('fpOtpErr');
    const fpVerifiedPill = document.getElementById('fpVerifiedPill');
    const fpPassFieldset = document.getElementById('fpPassFieldset');
    const fpPass         = document.getElementById('fpPass');
    const fpConf         = document.getElementById('fpConf');
    const fpSubmit       = document.getElementById('fpSubmit');
    const fpOtpFlag      = document.getElementById('fp_otp_verified');
 
    let fpOTP = null;
 
    function resetFpUI(){
      fpSentInfo.classList.add('d-none');
      fpOtpRow.classList.add('d-none');
      fpVerifiedPill.classList.add('d-none');
      fpOtpErr.classList.add('d-none');
      fpOtpBoxes.forEach(x=>x.value=''); fpOtpHidden.value='';
      fpResendBtn.disabled=true;
      fpOtpFlag.value='0';
      fpPassFieldset.disabled=true;
      fpSubmit.disabled=true;
    }
 
    fpSendOtpBtn.addEventListener('click', ()=>{
      const v = (fpEmail.value||'').trim();
      if(!emailRe.test(v)){ fpEmail.classList.add('is-invalid'); return; }
      fpEmail.classList.remove('is-invalid');
 
      fpOTP = Math.floor(100000+Math.random()*900000);
      fpSentTargetPill.innerHTML = `<i class="bi bi-check2-circle"></i> Sent to: ${maskTarget(v)}`;
      fpOtpValue.textContent = String(fpOTP);
      fpSentInfo.classList.remove('d-none');
      fpOtpRow.classList.remove('d-none');
      startCountdown(fpResendBtn,30);
      fpOtpBoxes[0].focus();
    });
 
    fpCopyOtpBtn.addEventListener('click', ()=>{
      if(!fpOTP) return;
      navigator.clipboard.writeText(String(fpOTP));
      fpCopyOtpBtn.innerHTML = '<i class="bi bi-clipboard-check text-success"></i>';
      setTimeout(()=> fpCopyOtpBtn.innerHTML = '<i class="bi bi-clipboard"></i>', 1200);
    });
 
    fpResendBtn.addEventListener('click', ()=>{
      if(!fpOTP) return;
      fpOTP = Math.floor(100000+Math.random()*900000);
      document.getElementById('fpOtpValue').textContent = String(fpOTP);
      startCountdown(fpResendBtn,30);
      fpOtpBoxes.forEach(x=>x.value=''); fpOtpHidden.value='';
      fpOtpBoxes[0].focus();
    });
 
    fpOtpVerifyBtn.addEventListener('click', ()=>{
      if((fpOtpHidden.value||'') === String(fpOTP)){
        fpOtpErr.classList.add('d-none');
        fpVerifiedPill.classList.remove('d-none');
        fpPassFieldset.disabled=false;
        fpSubmit.disabled=false;
        fpOtpFlag.value='1';
      }else{
        fpOtpErr.classList.remove('d-none');
      }
    });
 
    const forgotModalEl = document.getElementById('forgotModal');
    forgotModalEl.addEventListener('shown.bs.modal', resetFpUI);
    forgotModalEl.addEventListener('hidden.bs.modal', resetFpUI);
  </script>
</body>
</html>
 
 