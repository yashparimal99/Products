<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Customer Database - DigiBank Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
 
  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
 
  <style>
    :root {
      --primary-color: #0B4D83;
      --secondary-color: #7a0f3e;
      --light-bg: #f8f9fa;
      --hover-color: #f0d7e0;
    }
    
    body {
      background-color: var(--light-bg);
      font-family: 'Segoe UI', sans-serif;
      padding: 0;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    /* Top Bar Styles */
    .top-bar {
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      user-select: none;
      position: sticky;
      top: 0;
      z-index: 1030;
    }
    
    .top-bar h5 {
      margin: 0;
      font-weight: 700;
      flex-grow: 1;
      text-align: center;
      color: white;
    }
    
    .top-bar button.btn-outline-light {
      border: 1.5px solid white;
      color: white;
      background: transparent;
      padding: 4px 10px;
      font-size: 1.3rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s;
    }
    
    .top-bar button.btn-outline-light:hover {
      background-color: white;
      color: var(--primary-color);
    }
    
    .logout-btn {
      background: transparent;
      border: 1.5px solid white;
      color: white;
      padding: 5px 15px;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s;
      flex-shrink: 0;
    }
    
    .logout-btn:hover {
      background-color: white;
      color: var(--primary-color);
    }
    
    /* Sidebar Offcanvas */
    #sidebarMenu.offcanvas-start {
      width: 250px;
    }
    
    #sidebarMenu .offcanvas-body {
      padding: 0.5rem 1rem;
    }
    
    #sidebarMenu .nav-link {
      font-size: 0.9rem;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #333;
      transition: color 0.3s;
    }
    
    #sidebarMenu .nav-link i {
      font-size: 1.1rem;
    }
    
    #sidebarMenu .nav-link.active {
      font-weight: 700;
      color: var(--primary-color) !important;
      background-color: var(--hover-color);
      border-radius: 4px;
    }
    
    #sidebarMenu .nav-link:hover {
      color: var(--secondary-color);
      background-color: #f9e5ef;
      border-radius: 4px;
    }
    
    /* Main Content Container */
    .main-container {
      flex: 1;
      padding: 20px;
      width: 100%;
      max-width: 100%;
    }
    
    /* Page Header */
    .page-header {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 25px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .page-header h2 {
      color: var(--primary-color);
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .user-count-badge {
      background-color: var(--primary-color);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    /* Filter Controls */
    .filter-section {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      margin-bottom: 25px;
    }
    
    .filter-dropdown {
      padding: 10px 15px;
      border: 1.5px solid #ddd;
      border-radius: 6px;
      background-color: white;
      font-size: 0.95rem;
      width: 100%;
    }
    
    /* User List Container */
    .user-list-container {
      display: flex;
      gap: 20px;
      height: 65vh;
    }
    
    .user-list-section {
      flex: 1;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .user-list-header {
      background-color: #f8f9fa;
      padding: 15px 20px;
      border-bottom: 2px solid #eee;
      display: grid;
      grid-template-columns: 1fr 1.5fr 1.2fr 1fr 0.8fr;
      font-weight: 600;
      color: var(--primary-color);
      flex-shrink: 0;
    }
    
    .user-list {
      flex: 1;
      overflow-y: auto;
    }
    
    .user-row {
      padding: 12px 20px;
      border-bottom: 1px solid #f0f0f0;
      display: grid;
      grid-template-columns: 1fr 1.5fr 1.2fr 1fr 0.8fr;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.2s;
      min-height: 56px;
    }
    
    .user-row:hover {
      background-color: #f8fafc;
    }
    
    .user-row.active {
      background-color: #eef5ff;
      border-left: 4px solid var(--primary-color);
    }
    
    .user-name {
      font-weight: 600;
      color: var(--primary-color);
      font-size: 0.95rem;
    }
    
    .user-account {
      color: #555;
      font-family: monospace;
      font-size: 0.9rem;
    }
    
    .user-ifsc {
      color: #444;
      font-family: monospace;
      font-size: 0.85rem;
    }
    
    .user-status {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      text-align: center;
      width: fit-content;
      min-width: 70px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-active {
      background-color: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
    }
    
    .status-inactive {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ffcdd2;
    }
    
    /* User Details Section */
    .user-details-section {
      flex: 1;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .user-details-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 15px 25px;
      flex-shrink: 0;
    }
    
    .user-details-header h3 {
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0;
    }
    
    .user-details-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    /* Detail Groups */
    .detail-group {
      margin-bottom: 20px;
    }
    
    .detail-group h4 {
      color: var(--primary-color);
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid #eee;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .detail-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px dashed #f0f0f0;
      font-size: 0.9rem;
    }
    
    .detail-label {
      color: #666;
      font-weight: 500;
      flex: 1;
    }
    
    .detail-value {
      color: #333;
      font-weight: 600;
      text-align: right;
      flex: 1;
      word-break: break-word;
      padding-left: 10px;
    }
    
    /* Bank Codes Section */
    .bank-codes-section {
      display: flex;
      gap: 10px;
      margin-top: 5px;
    }
    
    .bank-code-item {
      background-color: #f0f7ff;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #d1e3ff;
      flex: 1;
    }
    
    .bank-code-label {
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 2px;
    }
    
    .bank-code-value {
      font-weight: 600;
      color: var(--primary-color);
      font-family: monospace;
      font-size: 0.85rem;
    }
    
    /* No User Selected State */
    .no-user-selected {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 30px;
      text-align: center;
      color: #777;
    }
    
    .no-user-selected i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: #ddd;
    }
    
    .no-user-selected h3 {
      font-size: 1.3rem;
      margin-bottom: 10px;
      color: #555;
    }
    
    /* Pagination */
    .pagination-section {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      flex-wrap: wrap;
      gap: 5px;
    }
    
    .page-btn {
      padding: 6px 12px;
      margin: 0 2px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 36px;
      text-align: center;
      font-size: 0.9rem;
    }
    
    .page-btn:hover {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    .page-btn.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Footer */
    footer.bg-custom {
      background-color: var(--primary-color);
      color: white;
      text-align: center;
      padding: 12px;
      margin-top: auto;
      font-size: 0.9rem;
    }
    
    /* Loading Spinner */
    .spinner-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px;
    }
    
    /* Error State */
    .error-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px;
      text-align: center;
      color: #dc3545;
    }
    
    /* Responsive Design */
    @media (max-width: 1200px) {
      .user-list-header, .user-row {
        grid-template-columns: 1fr 1.5fr 1fr 0.8fr;
      }
      
      .user-ifsc {
        display: none;
      }
    }
    
    @media (max-width: 992px) {
      .user-list-container {
        flex-direction: column;
        height: auto;
        gap: 15px;
      }
      
      .user-list-section, .user-details-section {
        height: 45vh;
      }
    }
    
    @media (max-width: 768px) {
      .user-list-header, .user-row {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        padding: 10px 15px;
      }
      
      .user-account, .user-status {
        grid-column: span 2;
      }
      
      .bank-codes-section {
        flex-direction: column;
        gap: 8px;
      }
      
      .page-header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
      }
      
      .filter-section .row {
        gap: 12px;
      }
      
      .detail-item {
        flex-direction: column;
        gap: 2px;
      }
      
      .detail-label, .detail-value {
        text-align: left;
        width: 100%;
        padding-left: 0;
      }
    }
    
    /* Logo Styles */
    .digi-bank-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      transition: transform 0.3s ease;
    }
    
    .digi-bank-logo:hover {
      transform: scale(1.05);
    }
    
    .logo-icon {
      width: 45px;
      height: 45px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3), 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .logo-icon::before {
      content: '';
      position: absolute;
      top: 6px;
      left: 6px;
      right: 6px;
      bottom: 6px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 6px;
    }
    
    .logo-icon::after {
      content: 'D';
      position: absolute;
      color: transparent;
      background: linear-gradient(135deg, #667eea, #764ba2);
      background-clip: text;
      -webkit-background-clip: text;
      font-weight: 800;
      font-size: 18px;
      z-index: 2;
    }
    
    .logo-text {
      color: #fff;
    }
    
    .main-text {
      font-size: 18px;
      font-weight: 800;
      letter-spacing: -0.5px;
      line-height: 1;
    }
    
    .digi {
      background: linear-gradient(135deg, #87CEEB 0%, #98D8E8 25%, #FFF8DC 50%, #87CEFA 100%);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
    }
    
    .bank {
      color: #ffffff;
      margin-left: 2px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    .tagline {
      font-size: 8px;
      font-weight: 600;
      color: #e8f4f8;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      margin-top: 2px;
    }
    
    /* Loading skeleton */
    .skeleton-loading {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 4px;
      height: 18px;
      margin: 4px 0;
    }
    
    @keyframes loading {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }
    
    .skeleton-row {
      padding: 12px 20px;
      border-bottom: 1px solid #f0f0f0;
      display: grid;
      grid-template-columns: 1fr 1.5fr 1.2fr 1fr 0.8fr;
      align-items: center;
    }
    
    /* Compact table styles */
    .compact-table {
      font-size: 0.9rem;
    }
    
    /* Filter section improvements */
    .filter-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
  </style>
</head>
<body>
  <!-- Sidebar Offcanvas -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="sidebarMenuLabel">Manager</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="nav flex-column">
        <li class="nav-item mb-2">
          <a class="nav-link text-dark" href="{{ url_for('dashboard') }}">
            <i class="bi bi-speedometer2 me-2"></i> Dashboard
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link text-dark" href="{{ url_for('managerapprovals') }}">
            <i class="bi bi-people-fill me-2"></i> Manage Approvals
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link text-dark" href="{{ url_for('manstaff') }}">
            <i class="bi bi-file-earmark-check me-2"></i> Staff Management
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link text-dark active" href="{{ url_for('bankuser_manend') }}">
            <i class="bi bi-people me-2"></i> Customer Database
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link text-dark" href="{{ url_for('transactions_review') }}">
            <i class="bi bi-list-check me-2"></i> Transaction Review
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link text-dark" href="{{ url_for('manreport') }}">
            <i class="bi bi-graph-up me-2"></i> Reports & Analytics
          </a>
        </li>
      </ul>
    </div>
  </div>
 
  <!-- Top Bar -->
  <div class="top-bar d-flex align-items-center px-3 py-2">
    <!-- Sidebar Toggle -->
    <button class="btn btn-outline-light btn-sm me-3"
            data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu"
            aria-controls="sidebarMenu" aria-label="Toggle sidebar">
      <i class="bi bi-list fs-5"></i>
    </button>
 
    <!-- DigiBank Logo -->
    <a class="navbar-brand digi-bank-logo d-flex align-items-center me-3" href="{{ url_for('home') }}">
      <div class="logo-icon"></div>
      <div class="logo-text ms-2">
        <div class="main-text">
          <span class="digi">DiGi</span><span class="bank">Bank</span>
        </div>
        <div class="tagline">Smart Banking</div>
      </div>
    </a>
 
    <!-- Title - Changed to Customer Database -->
    <h5 class="flex-grow-1 text-center m-0">Bank User List</h5>
 
    <!-- Right Side: User + Logout -->
    <div class="d-flex align-items-center">
      <h5 class="m-0 me-2 fs-6">Welcome, {{ user.name }} !</h5>
      <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm ms-3">
        Logout
      </a>
    </div>
  </div>
 
  <!-- Main Content Container -->
  <div class="main-container">
    <!-- Page Header -->
    <div class="page-header">
      <h2><i class="fas fa-users"></i> Customer Database</h2>
      <div class="user-count-badge">
        Total Customers: <span id="totalUserCount">0</span>
      </div>
    </div>
 
    <!-- Filter Controls -->
    <div class="filter-section">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <div class="form-group">
            <label class="form-label fw-semibold">Search Customers</label>
            <input type="text" id="userSearchInput" class="form-control" 
                   placeholder="Search by name, account number, IFSC, phone or email...">
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <label class="form-label fw-semibold">Status</label>
            <select class="filter-dropdown form-select" id="statusFilter">
              <option value="all">All Status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <label class="form-label fw-semibold">Account Type</label>
            <select class="filter-dropdown form-select" id="typeFilter">
              <option value="all">All Types</option>
              <option value="savings">Savings</option>
              <option value="current">Current</option>
              <option value="loan">Loan Account</option>
              <option value="fixed">Fixed Deposit</option>
            </select>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <label class="form-label fw-semibold">Sort By</label>
            <select class="filter-dropdown form-select" id="sortFilter">
              <option value="name">Name (A-Z)</option>
              <option value="balance">Balance (High-Low)</option>
              <option value="date">Account Date (Newest)</option>
            </select>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <label class="form-label fw-semibold">Branch</label>
            <select class="filter-dropdown form-select" id="branchFilter">
              <option value="all">All Branches</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-12 d-flex justify-content-between align-items-center">
          <div class="filter-actions">
            <button id="refreshBtn" class="btn btn-outline-primary btn-sm">
              <i class="fas fa-sync-alt me-1"></i> Refresh
            </button>
            <button id="exportBtn" class="btn btn-outline-success btn-sm ms-2">
              <i class="fas fa-download me-1"></i> Export
            </button>
          </div>
          <div class="text-muted small">
            Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> customers
          </div>
        </div>
      </div>
    </div>
 
    <!-- User List Container -->
    <div class="user-list-container">
      <!-- User List Section -->
      <div class="user-list-section">
        <div class="user-list-header">
          <div>ID</div>
          <div>Full Name</div>
          <div>Account No.</div>
          <div>IFSC</div>
          <div>Status</div>
        </div>
        <div class="user-list" id="userList">
          <!-- Loading skeleton -->
          <div class="skeleton-row">
            <div class="skeleton-loading"></div>
            <div class="skeleton-loading"></div>
            <div class="skeleton-loading"></div>
            <div class="skeleton-loading"></div>
            <div class="skeleton-loading" style="width: 60px; margin-left: auto; margin-right: auto;"></div>
          </div>
          <div class="skeleton-row">
            <div class="skeleton-loading"></div>
            <div class="skeleton-loading"></div>
            <div class="skeleton-loading"></div>
            <div class="skeleton-loading"></div>
            <div class="skeleton-loading" style="width: 60px; margin-left: auto; margin-right: auto;"></div>
          </div>
          <div class="skeleton-row">
            <div class="skeleton-loading"></div>
            <div class="skeleton-loading"></div>
            <div class="skeleton-loading"></div>
            <div class="skeleton-loading"></div>
            <div class="skeleton-loading" style="width: 60px; margin-left: auto; margin-right: auto;"></div>
          </div>
        </div>
      </div>
 
      <!-- Customer Details Section -->
      <div class="user-details-section">
        <div class="user-details-header">
          <h3><i class="fas fa-user-circle"></i> Customer Details</h3>
        </div>
        <div class="user-details-content" id="userDetails">
          <div class="no-user-selected">
            <i class="fas fa-user-friends"></i>
            <h3>No Customer Selected</h3>
            <p>Click on a customer from the list to view their detailed information</p>
          </div>
        </div>
      </div>
    </div>
 
    <!-- Pagination -->
    <div class="pagination-section mt-3" id="pagination">
      <!-- Pagination will be dynamically added here -->
    </div>
  </div>
 
  <!-- Footer -->
  <footer class="bg-custom text-white text-center py-3">
    © 2025 DigiBank. Customer Database Management. All rights reserved.
  </footer>
 
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
 
  <script>
    // DOM elements
    const userListElement = document.getElementById('userList');
    const userDetailsElement = document.getElementById('userDetails');
    const userSearchInput = document.getElementById('userSearchInput');
    const statusFilter = document.getElementById('statusFilter');
    const typeFilter = document.getElementById('typeFilter');
    const sortFilter = document.getElementById('sortFilter');
    const branchFilter = document.getElementById('branchFilter');
    const totalUserCountElement = document.getElementById('totalUserCount');
    const showingCountElement = document.getElementById('showingCount');
    const totalCountElement = document.getElementById('totalCount');
    const paginationElement = document.getElementById('pagination');
    const refreshBtn = document.getElementById('refreshBtn');
    const exportBtn = document.getElementById('exportBtn');

    // Initialize variables
    let filteredUsers = [];
    let selectedUser = null;
    let currentPage = 1;
    let totalPages = 1;
    let totalUsers = 0;
    const usersPerPage = 12;

    // Show loading skeleton
    function showLoadingSkeleton(count = 6) {
      userListElement.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const skeletonRow = document.createElement('div');
        skeletonRow.className = 'skeleton-row';
        skeletonRow.innerHTML = `
          <div class="skeleton-loading"></div>
          <div class="skeleton-loading"></div>
          <div class="skeleton-loading"></div>
          <div class="skeleton-loading"></div>
          <div class="skeleton-loading" style="width: 60px; margin-left: auto; margin-right: auto;"></div>
        `;
        userListElement.appendChild(skeletonRow);
      }
    }

    // Build query params helper (only include if not default)
    function buildParams() {
      const params = {};
      if (userSearchInput.value) params.search = userSearchInput.value;
      if (statusFilter.value && statusFilter.value !== 'all') params.status = statusFilter.value;
      if (typeFilter.value && typeFilter.value !== 'all') params.type = typeFilter.value;
      if (sortFilter.value) params.sort = sortFilter.value;
      if (branchFilter.value && branchFilter.value !== 'all') params.branch = branchFilter.value;
      params.page = currentPage;
      params.per_page = usersPerPage;
      return new URLSearchParams(params).toString();
    }

    // Fetch customers from database
    async function fetchCustomers() {
      try {
        showLoadingSkeleton();
        
        // Build query parameters
        const qs = buildParams();
        const url = `/api/bank_users${qs ? '?' + qs : ''}`;

        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
          // Map backend users to UI expected fields (backend uses user_id / ifsc_code)
          filteredUsers = data.users.map(u => ({
            customer_id: u.customer_id || u.user_id || u.userId || '', // support variations
            name: u.name || '',
            account_number: u.account_number || u.customer_id || u.user_id || '',
            ifsc: u.ifsc || u.ifsc_code || '',
            status: (u.status || 'inactive').toLowerCase()
          }));

          // Pagination metadata if provided by backend
          totalPages = data.total_pages || 1;
          totalUsers = data.total || filteredUsers.length;
          totalUserCountElement.textContent = totalUsers;
          totalCountElement.textContent = totalUsers;
          showingCountElement.textContent = filteredUsers.length;

          renderUserList();
          
          // Auto-select first user if none selected
          if (!selectedUser && filteredUsers.length > 0) {
            selectUser(filteredUsers[0]);
          }
        } else {
          console.error('Error fetching customers:', data.error || data.message);
          showError('Failed to load customers. Please try again.');
        }
      } catch (error) {
        console.error('Error fetching customers:', error);
        showError('Network error. Please check your connection.');
      }
    }

    // Fetch customer details
    async function fetchCustomerDetails(customerId) {
      try {
        const response = await fetch(`/api/bank_user/${encodeURIComponent(customerId)}`);
        const data = await response.json();

        if (data.success) {
          // backend returns user object under data.user or user
          return data.user || data.data || data;
        } else {
          console.error('Error fetching customer details:', data.error || data.message);
          return null;
        }
      } catch (error) {
        console.error('Error fetching customer details:', error);
        return null;
      }
    }

    // Fetch branch list (graceful - may not exist server-side yet)
    async function fetchBranches() {
      try {
        const response = await fetch('/api/bank_stats');
        if (!response.ok) return;
        const data = await response.json();
        
        if (data.success && data.stats && data.stats.by_branch) {
          // Clear existing options except "All Branches"
          branchFilter.innerHTML = '<option value="all">All Branches</option>';
          
          // Add branch options
          data.stats.by_branch.forEach(branch => {
            const option = document.createElement('option');
            option.value = branch.branch;
            option.textContent = branch.branch;
            branchFilter.appendChild(option);
          });
        }
      } catch (error) {
        // no-op if not available
        console.error('Error fetching branches (non-fatal):', error);
      }
    }

    // Render user list
    function renderUserList() {
      userListElement.innerHTML = '';
      
      if (filteredUsers.length === 0) {
        userListElement.innerHTML = `
          <div style="padding: 40px; text-align: center; color: #777;">
            <i class="fas fa-search" style="font-size: 2.5rem; margin-bottom: 15px;"></i>
            <h3 style="font-size: 1.2rem;">No customers found</h3>
            <p style="font-size: 0.9rem;">Try adjusting your search or filters</p>
          </div>
        `;
        renderPagination();
        return;
      }
      
      filteredUsers.forEach(user => {
        const userRow = document.createElement('div');
        userRow.className = `user-row ${selectedUser && (selectedUser.customer_id === user.customer_id) ? 'active' : ''}`;
        // show account_number as customer_id (temporary) because account table not present
        userRow.innerHTML = `
          <div style="font-size: 0.85rem;">${user.customer_id || ''}</div>
          <div class="user-name">${escapeHtml(user.name || '')}</div>
          <div class="user-account">${escapeHtml(user.account_number || user.customer_id || '')}</div>
          <div class="user-ifsc">${escapeHtml(user.ifsc || 'N/A')}</div>
          <div class="user-status ${user.status === 'active' ? 'status-active' : 'status-inactive'}">${(user.status || '').charAt(0).toUpperCase() + (user.status || '').slice(1)}</div>
        `;
        
        userRow.addEventListener('click', () => {
          selectUser(user);
        });
        
        userListElement.appendChild(userRow);
      });
      
      renderPagination();
    }

    // Render pagination
    function renderPagination() {
      paginationElement.innerHTML = '';
      
      if (totalPages <= 1) return;
      
      // Previous button
      const prevBtn = document.createElement('button');
      prevBtn.className = 'page-btn';
      prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
      prevBtn.disabled = currentPage === 1;
      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          fetchCustomers();
        }
      });
      paginationElement.appendChild(prevBtn);
      
      // Page numbers
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      // Adjust start page if we're at the end
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      // First page
      if (startPage > 1) {
        const firstBtn = document.createElement('button');
        firstBtn.className = 'page-btn';
        firstBtn.textContent = '1';
        firstBtn.addEventListener('click', () => {
          currentPage = 1;
          fetchCustomers();
        });
        paginationElement.appendChild(firstBtn);
        
        if (startPage > 2) {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.style.padding = '6px 4px';
          ellipsis.style.color = '#666';
          paginationElement.appendChild(ellipsis);
        }
      }
      
      // Page numbers
      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
        pageBtn.textContent = i;
        pageBtn.addEventListener('click', () => {
          currentPage = i;
          fetchCustomers();
        });
        paginationElement.appendChild(pageBtn);
      }
      
      // Last page
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.style.padding = '6px 4px';
          ellipsis.style.color = '#666';
          paginationElement.appendChild(ellipsis);
        }
        
        const lastBtn = document.createElement('button');
        lastBtn.className = 'page-btn';
        lastBtn.textContent = totalPages;
        lastBtn.addEventListener('click', () => {
          currentPage = totalPages;
          fetchCustomers();
        });
        paginationElement.appendChild(lastBtn);
      }
      
      // Next button
      const nextBtn = document.createElement('button');
      nextBtn.className = 'page-btn';
      nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          fetchCustomers();
        }
      });
      paginationElement.appendChild(nextBtn);
    }

    // Utility: escape HTML to avoid injection when inserting user content
    function escapeHtml(unsafe) {
      if (!unsafe && unsafe !== 0) return '';
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Select user and show details
    async function selectUser(user) {
      selectedUser = user;
      renderUserList();
      
      // Show loading state
      userDetailsElement.innerHTML = `
        <div class="spinner-container">
          <div class="spinner-border text-primary" role="status" style="width: 2.5rem; height: 2.5rem;">
            <span class="visually-hidden">Loading...</span>
          </div>
          <h3 class="mt-3" style="font-size: 1.1rem;">Loading customer details...</h3>
        </div>
      `;
      
      // Fetch detailed customer information
      const detailedUser = await fetchCustomerDetails(user.customer_id);
      if (detailedUser) {
        renderUserDetails(detailedUser);
      } else {
        userDetailsElement.innerHTML = `
          <div class="error-state">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i>
            <h3 style="font-size: 1.2rem;">Failed to load details</h3>
            <p style="font-size: 0.9rem;">Could not load detailed information for this customer</p>
            <button class="btn btn-primary btn-sm mt-3" onclick="selectUser(${JSON.stringify(user).replace(/"/g, '&quot;')})">
              <i class="fas fa-redo"></i> Try Again
            </button>
          </div>
        `;
      }
    }

    // Render user details
    function renderUserDetails(user) {
      // normalize fields coming from backend
      const u = {
        customer_id: user.customer_id || user.user_id || user.userId || '',
        name: user.name || '',
        dob: user.dob || user.onboarding_date || '',
        occupation: user.occupation || '',
        monthly_income: user.monthly_income || 0,
        address: user.address || '',
        account_number: user.account_number || user.customer_id || user.user_id || '',
        account_type: user.account_type || '',
        balance: user.balance || 0,
        account_open_date: user.account_open_date || user.onboarding_date || '',
        ifsc: user.ifsc || user.ifsc_code || '',
        branch_code: user.branch_code || '',
        branch_name: user.branch_name || 'Main Branch',
        branch_city: user.branch_city || user.city || '',
        pan: user.pan || '',
        aadhaar: user.aadhaar || '',
        kyc_status: user.kyc_status || (user.pan ? 'Verified' : 'Pending'),
        nominee: user.nominee || 'Not specified',
        loans: user.loans || [],
        credit_card: user.credit_card || 'No credit card',
        fdAccounts: user.fdAccounts || [],
        email: user.email || '',
        phone: user.phone || user.mobile || ''
      };

      const loansDisplay = (u.loans.length > 0) ? u.loans.map(l => escapeHtml(l)).join('<br>') : 'No active loans';
      const fdsDisplay = (u.fdAccounts.length > 0) ? u.fdAccounts.map(f => escapeHtml(f)).join('<br>') : 'No active FDs';

      userDetailsElement.innerHTML = `
        <div class="detail-group">
          <h4><i class="fas fa-id-card"></i> Personal Information</h4>
          <div class="detail-item">
            <span class="detail-label">Full Name:</span>
            <span class="detail-value">${escapeHtml(u.name)}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Date of Birth:</span>
            <span class="detail-value">${escapeHtml(u.dob) || 'N/A'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Occupation:</span>
            <span class="detail-value">${escapeHtml(u.occupation) || 'Not specified'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Monthly Income:</span>
            <span class="detail-value">₹ ${Number(u.monthly_income || 0).toLocaleString('en-IN')}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Address:</span>
            <span class="detail-value">${escapeHtml(u.address)}</span>
          </div>
        </div>
        
        <div class="detail-group">
          <h4><i class="fas fa-file-contract"></i> Account Information</h4>
          <div class="detail-item">
            <span class="detail-label">Customer ID:</span>
            <span class="detail-value">${escapeHtml(u.customer_id)}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Account Number:</span>
            <span class="detail-value">${escapeHtml(u.account_number)}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Account Type:</span>
            <span class="detail-value">${escapeHtml((u.account_type || '').charAt(0).toUpperCase() + (u.account_type || '').slice(1))}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Current Balance:</span>
            <span class="detail-value">₹ ${Number(u.balance || 0).toLocaleString('en-IN')}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Account Open Date:</span>
            <span class="detail-value">${escapeHtml(u.account_open_date) || 'N/A'}</span>
          </div>
        </div>
        
        <div class="detail-group">
          <h4><i class="fas fa-university"></i> Bank & Branch Details</h4>
          <div class="bank-codes-section">
            <div class="bank-code-item">
              <div class="bank-code-label">IFSC Code</div>
              <div class="bank-code-value">${escapeHtml(u.ifsc) || 'N/A'}</div>
            </div>
            <div class="bank-code-item">
              <div class="bank-code-label">Branch Code</div>
              <div class="bank-code-value">${escapeHtml(u.branch_code) || 'N/A'}</div>
            </div>
          </div>
          <div class="detail-item" style="margin-top: 10px;">
            <span class="detail-label">Branch Name:</span>
            <span class="detail-value">${escapeHtml(u.branch_name)}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Branch City:</span>
            <span class="detail-value">${escapeHtml(u.branch_city) || 'Not specified'}</span>
          </div>
        </div>
        
        <div class="detail-group">
          <h4><i class="fas fa-shield-alt"></i> KYC & Verification</h4>
          <div class="detail-item">
            <span class="detail-label">PAN Number:</span>
            <span class="detail-value">${escapeHtml(u.pan) || 'Not specified'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Aadhaar Number:</span>
            <span class="detail-value">${escapeHtml(u.aadhaar) || 'Not specified'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">KYC Status:</span>
            <span class="detail-value">
              <span style="color: ${(u.kyc_status || '').includes('Verified') ? '#2e7d32' : (u.kyc_status || '').includes('Pending') ? '#ef6c00' : '#c62828'}; font-weight: 600;">
                ${escapeHtml(u.kyc_status || 'Not verified')}
              </span>
            </span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Nominee:</span>
            <span class="detail-value">${escapeHtml(u.nominee || 'Not specified')}</span>
          </div>
        </div>
        
        <div class="detail-group">
          <h4><i class="fas fa-hand-holding-usd"></i> Financial Products</h4>
          <div class="detail-item">
            <span class="detail-label">Active Loans:</span>
            <span class="detail-value">${loansDisplay}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Credit Card:</span>
            <span class="detail-value">${escapeHtml(u.credit_card || 'No credit card')}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Fixed Deposits:</span>
            <span class="detail-value">${fdsDisplay}</span>
          </div>
        </div>
        
        <div class="detail-group">
          <h4><i class="fas fa-address-book"></i> Contact Information</h4>
          <div class="detail-item">
            <span class="detail-label">Email Address:</span>
            <span class="detail-value">${escapeHtml(u.email) || 'Not specified'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Phone Number:</span>
            <span class="detail-value">${escapeHtml(u.phone) || 'Not specified'}</span>
          </div>
        </div>
      `;
    }

    // Export data function
    async function exportData() {
      try {
        // Build query parameters for all data (no pagination)
        const params = new URLSearchParams({
          search: userSearchInput.value,
          status: statusFilter.value,
          type: typeFilter.value,
          sort: sortFilter.value,
          branch: branchFilter.value,
          page: 1,
          per_page: 10000 // Large number to get all data
        });

        const response = await fetch(`/api/bank_users?${params}`);
        const data = await response.json();

        if (data.success && data.users.length > 0) {
          // Convert to CSV
          const headers = ['Customer ID', 'Name', 'Account Number', 'Account Type', 'Balance', 'Status', 'IFSC', 'Branch', 'Phone', 'Email'];
          const csvData = data.users.map(user => [
            user.customer_id,
            `"${user.name}"`,
            user.account_number || user.customer_id,
            user.account_type || '',
            user.balance || '',
            user.status,
            user.ifsc,
            user.branch_name || 'Main Branch',
            user.phone || user.mobile || '',
            user.email || ''
          ]);
          
          const csvContent = [
            headers.join(','),
            ...csvData.map(row => row.join(','))
          ].join('\n');
          
          // Create download link
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `customers_${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // Show success message
          alert(`Exported ${data.users.length} customers successfully!`);
        } else {
          alert('No data to export.');
        }
      } catch (error) {
        console.error('Error exporting data:', error);
        alert('Failed to export data. Please try again.');
      }
    }

    // Show error message
    function showError(message) {
      userListElement.innerHTML = `
        <div style="padding: 30px; text-align: center; color: #dc3545;">
          <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 15px;"></i>
          <h3 style="font-size: 1.2rem;">Error Loading Data</h3>
          <p style="font-size: 0.9rem;">${message}</p>
          <button class="btn btn-primary btn-sm mt-3" onclick="fetchCustomers()">
            <i class="fas fa-redo"></i> Try Again
          </button>
        </div>
      `;
    }

    // Debounce function for search
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Event listeners with debounce
    const debouncedFetchCustomers = debounce(() => {
      currentPage = 1;
      fetchCustomers();
    }, 300);
    
    userSearchInput.addEventListener('input', debouncedFetchCustomers);
    statusFilter.addEventListener('change', debouncedFetchCustomers);
    typeFilter.addEventListener('change', debouncedFetchCustomers);
    sortFilter.addEventListener('change', debouncedFetchCustomers);
    branchFilter.addEventListener('change', debouncedFetchCustomers);
    
    // Refresh button
    refreshBtn.addEventListener('click', () => {
      currentPage = 1;
      userSearchInput.value = '';
      statusFilter.value = 'all';
      typeFilter.value = 'all';
      sortFilter.value = 'name';
      branchFilter.value = 'all';
      fetchCustomers();
    });
    
    // Export button
    exportBtn.addEventListener('click', exportData);

    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
      fetchCustomers();
      fetchBranches();
    });
 
  const branchMapping = {
  "BR-HQ-000": { name: "Headoffice", city: "Amravati" },
  "BR-MUM-001": { name: "Mumbai Branch", city: "Mumbai" },
  "BR-DEL-002": { name: "Delhi Branch", city: "Delhi" },
  "BR-BLR-005": { name: "Bangalore Branch", city: "Bangalore" },
  "BR-HYD-004": { name: "Hyderabad Branch", city: "Hyderabad" },
  "BR-PUN-003": { name: "Pune Branch", city: "Pune" }
};
  </script>
  
</body>
</html>
